<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - OPS BOARD</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style-mo.css">
</head>
<body>
    <div class="crt-overlay"></div>
    <div class="terminal-wrapper">
        <main class="terminal" style="max-width: 100%; height: 95vh; padding: 0;">

            <header class="header-strip" style="margin: 20px 30px;">
                <div>
                    <h1>OPS :: <span style="color:var(--danger)">BOARD</span></h1>
                    <div style="color: var(--dim); font-size: 0.9rem; letter-spacing: 3px;">TACTICAL COMMAND CENTER</div>
                </div>
                <div class="meta-data" style="display:flex; gap:10px;">
                    <button onclick="openCreateModal()" class="btn-tactical">
                        + NOUVELLE OP
                    </button>
                    <a href="index.html" class="btn-tactical secondary" style="text-decoration:none; padding-top:12px;">
                        RETOUR
                    </a>
                </div>
            </header>

            <div class="kanban-board">
                <div class="kanban-col">
                    <div class="col-header col-pending">
                        <span>/// PLANIFICATION</span>
                        <span class="count-badge" id="count-pending">0</span>
                    </div>
                    <div class="col-body" id="body-pending">
                    </div>
                </div>

                <div class="kanban-col">
                    <div class="col-header col-active">
                        <span class="blink">‚óè EN COURS</span>
                        <span class="count-badge" id="count-active">0</span>
                    </div>
                    <div class="col-body" id="body-active"></div>
                </div>

                <div class="kanban-col">
                    <div class="col-header col-completed">
                        <span>‚úì TERMIN√â</span>
                        <span class="count-badge" id="count-completed">0</span>
                    </div>
                    <div class="col-body" id="body-completed"></div>
                </div>
            </div>

        </main>
    </div>

    <div id="create-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-header-strip">
                <span class="modal-title">INITIALISATION MISSION</span>
                <button onclick="closeModals()" style="background:none; border:none; color:#666; cursor:pointer;">‚úñ</button>
            </div>

            <form id="create-form" class="modal-content-pad">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>NOM DE CODE</label>
                        <input type="text" id="m-title" class="form-input" placeholder="EX: OP√âRATION BLACKOUT" required>
                    </div>
                    <div class="form-group">
                        <label>D√âBUT (HEURE H)</label>
                        <input type="datetime-local" id="m-time" class="form-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>LOCALISATION / SECTEUR</label>
                    <input type="text" id="m-loc" class="form-input" placeholder="EX: ZONE INDUSTRIELLE, LS" required>
                </div>

                <div class="form-group">
                    <label>BRIEFING TACTIQUE</label>
                    <textarea id="m-desc" class="form-input" style="height:120px; resize:none;" placeholder="D√©tails de la mission..."></textarea>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:15px; margin-top:20px;">
                    <button type="button" onclick="closeModals()" class="btn-tactical secondary">ANNULER</button>
                    <button type="submit" class="btn-tactical">VALIDER L'ORDRE</button>
                </div>
            </form>
        </div>
    </div>

    <div id="detail-modal" class="modal-overlay hidden">
        <div class="modal-box" style="height: 80vh;">
            <div class="modal-header-strip">
                <span class="modal-title" id="d-title">OPERATION DETAIL</span>
                <div id="d-status-badge" class="count-badge" style="color:var(--primary); border-color:var(--primary);">STATUS</div>
            </div>

            <div class="modal-content-pad" style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; height: 100%; overflow: hidden;">

                <div style="display:flex; flex-direction:column; overflow-y:auto; padding-right:10px;">
                    <div style="margin-bottom:30px;">
                        <div style="color:var(--secondary); font-size:0.8rem; margin-bottom:10px; border-bottom:1px solid #333;">>> RAPPORT DE SITUATION</div>
                        <p id="d-desc" style="font-family:'JetBrains Mono'; font-size:0.9rem; line-height:1.6; color:#ccc;"></p>
                        <div style="margin-top:15px; color:#888; font-size:0.8rem;">üìç SECTEUR : <span id="d-loc" style="color:#fff;"></span></div>
                    </div>

                    <div style="flex:1;">
                        <div style="color:var(--secondary); font-size:0.8rem; margin-bottom:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                            <span>>> EFFECTIFS ASSIGN√âS</span>
                        </div>

                        <div id="d-roster-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:10px; margin-bottom:15px;">
                        </div>

                        <div style="display:flex; gap:10px; background:rgba(255,255,255,0.02); padding:10px; border:1px solid #333;">
                            <input type="text" id="add-agent-input" class="form-input" placeholder="Ajouter Agent..." style="padding:8px; font-size:0.8rem;">
                            <button onclick="addAgentToMission()" class="btn-tactical secondary" style="padding:5px 15px;">+</button>
                        </div>
                    </div>
                </div>

                <div style="background:rgba(0,0,0,0.3); padding:20px; border-left:1px solid #333; display:flex; flex-direction:column;">

                    <div style="flex:1; margin-bottom:20px;">
                        <div style="color:var(--warning); font-size:0.8rem; margin-bottom:15px;">>> MAT√âRIEL REQUIS</div>
                        <div id="d-loadout-list" style="font-size:0.8rem; color:#aaa; margin-bottom:15px; max-height:200px; overflow-y:auto;"></div>

                        <select id="equip-select" class="form-input" style="font-size:0.8rem; padding:8px; margin-bottom:10px;">
                            <option>Chargement...</option>
                        </select>
                        <button onclick="addGearToMission()" class="btn-tactical secondary" style="width:100%; font-size:0.8rem;">R√âQUISITIONNER</button>
                    </div>

                    <div style="border-top:1px dashed #444; padding-top:20px;">
                        <div style="color:#666; font-size:0.7rem; margin-bottom:10px; text-align:center;">PANNEAU DE COMMANDE</div>
                        <button onclick="moveMission('PENDING')" class="btn-tactical secondary" style="width:100%; margin-bottom:8px;">REMETTRE EN ATTENTE</button>
                        <button onclick="moveMission('ACTIVE')" class="btn-tactical danger" style="width:100%; margin-bottom:8px;">LANCER MISSION</button>
                        <button onclick="moveMission('COMPLETED')" class="btn-tactical" style="width:100%;">CL√îTURER</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMissionId = null;
        let draggedCard = null;
        const token = localStorage.getItem('sas_token');

        document.addEventListener('DOMContentLoaded', () => {
            loadMissions();
            loadAvailableGear();
            setupDragAndDrop();
        });

        async function loadMissions() {
            try {
                const res = await fetch('/api/missions', { headers: { 'Authorization': `Bearer ${token}` } });
                const missions = await res.json();

                ['pending', 'active', 'completed'].forEach(s => document.getElementById(`body-${s}`).innerHTML = '');

                missions.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'mission-card';
                    card.setAttribute('draggable', 'true');
                    card.dataset.id = m.id;

                    let borderCol = 'var(--warning)';
                    if(m.status === 'ACTIVE') borderCol = 'var(--danger)';
                    if(m.status === 'COMPLETED') borderCol = 'var(--primary)';
                    card.style.borderLeftColor = borderCol;

                    const date = new Date(m.start_time).toLocaleDateString('fr-FR', {day: '2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});

                    card.innerHTML = `
                        <div class="m-title" style="color:${m.status === 'ACTIVE' ? 'var(--danger)' : '#fff'}">${m.title}</div>
                        <div class="m-meta">
                            <span>üìç ${m.location}</span>
                            <span>üïí ${date}</span>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:5px;">
                            <span class="m-roster-badge">üë§ ${m.roster.length}</span>
                            <span class="m-roster-badge" style="color:#ccc">üì¶ ${m.loadout.length}</span>
                        </div>
                    `;

                    card.onclick = () => openDetailModal(m);
                    card.addEventListener('dragstart', dragStart);
                    card.addEventListener('dragend', dragEnd);

                    const colId = `body-${m.status.toLowerCase()}`;
                    const col = document.getElementById(colId);
                    if(col) col.appendChild(card);
                });

                updateCounts();
            } catch(e) { console.error(e); }
        }

        function setupDragAndDrop() {
            document.querySelectorAll('.col-body').forEach(col => {
                col.addEventListener('dragover', e => { e.preventDefault(); col.style.background = 'rgba(255,255,255,0.02)'; });
                col.addEventListener('dragleave', e => { col.style.background = 'transparent'; });
                col.addEventListener('drop', async e => {
                    e.preventDefault();
                    col.style.background = 'transparent';
                    if (draggedCard) {
                        col.appendChild(draggedCard);
                        let newStatus = 'PENDING';
                        if (col.id === 'body-active') newStatus = 'ACTIVE';
                        if (col.id === 'body-completed') newStatus = 'COMPLETED';

                        if(newStatus === 'PENDING') draggedCard.style.borderLeftColor = 'var(--warning)';
                        if(newStatus === 'ACTIVE') draggedCard.style.borderLeftColor = 'var(--danger)';
                        if(newStatus === 'COMPLETED') draggedCard.style.borderLeftColor = 'var(--primary)';

                        const missionId = draggedCard.dataset.id;
                        await fetch('/api/missions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ action: 'move', id: missionId, status: newStatus })
                        });
                        updateCounts();
                    }
                });
            });
        }

        function dragStart(e) {
            draggedCard = this;
            this.style.opacity = '0.5';
            e.dataTransfer.setData('text/plain', this.dataset.id);
        }
        function dragEnd() {
            this.style.opacity = '1';
            draggedCard = null;
        }
        function updateCounts() {
            document.getElementById('count-pending').textContent = document.getElementById('body-pending').children.length;
            document.getElementById('count-active').textContent = document.getElementById('body-active').children.length;
            document.getElementById('count-completed').textContent = document.getElementById('body-completed').children.length;
        }

        async function loadAvailableGear() {
            const res = await fetch('/api/equipment', { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            const select = document.getElementById('equip-select');
            select.innerHTML = '<option value="">-- S√âLECTIONNER MAT√âRIEL --</option>';
            const available = data.inventory.filter(i => !i.assigned_to && !i.mission_id);
            available.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = `[${item.category}] ${item.item_name} (${item.serial_number})`;
                select.appendChild(opt);
            });
        }

        function openCreateModal() { document.getElementById('create-modal').classList.remove('hidden'); }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden')); currentMissionId = null; }

        function openDetailModal(mission) {
            currentMissionId = mission.id;
            document.getElementById('d-title').textContent = mission.title;
            document.getElementById('d-desc').textContent = mission.description || "Aucun briefing disponible.";
            document.getElementById('d-loc').textContent = mission.location;

            const rosterContainer = document.getElementById('d-roster-list');
            rosterContainer.innerHTML = mission.roster.map(agent =>
                `<div style="background:#222; border:1px solid #444; padding:5px; border-radius:4px; font-size:0.8rem; text-align:center; color:#fff;">${agent.toUpperCase()}</div>`
            ).join('');

            const loadoutContainer = document.getElementById('d-loadout-list');
            if(mission.loadout.length === 0) loadoutContainer.innerHTML = "<div style='font-style:italic;'>Aucun mat√©riel assign√©.</div>";
            else {
                loadoutContainer.innerHTML = mission.loadout.map(item =>
                    `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:5px 0;">
                        <span>${item.item_name}</span>
                        <span style="font-family:monospace; color:var(--primary);">${item.serial_number}</span>
                    </div>`
                ).join('');
            }

            document.getElementById('detail-modal').classList.remove('hidden');
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                action: 'create',
                title: document.getElementById('m-title').value,
                description: document.getElementById('m-desc').value,
                location: document.getElementById('m-loc').value,
                start_time: document.getElementById('m-time').value
            };
            await fetch('/api/missions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
            closeModals(); loadMissions();
        });

        async function moveMission(status) {
            if(!currentMissionId) return;
            await fetch('/api/missions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ action: 'move', id: currentMissionId, status: status }) });
            closeModals(); loadMissions();
        }

        async function addAgentToMission() {
            const agentName = document.getElementById('add-agent-input').value;
            if(!agentName) return;
            await fetch('/api/missions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ action: 'assign', mission_id: currentMissionId, agent: agentName }) });
            refreshDetails();
            document.getElementById('add-agent-input').value = '';
        }

        async function addGearToMission() {
            const gearId = document.getElementById('equip-select').value;
            if(!gearId) return;
            await fetch('/api/missions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ action: 'assign', mission_id: currentMissionId, equipment_id: gearId }) });
            refreshDetails(); loadAvailableGear();
        }

        async function refreshDetails() {
            const res = await fetch('/api/missions', { headers: { 'Authorization': `Bearer ${token}` } });
            const missions = await res.json();
            const mission = missions.find(m => m.id === currentMissionId);
            if(mission) openDetailModal(mission);
        }
    </script>
</body>
</html>