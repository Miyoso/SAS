<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - COMMAND CENTER [ADMIN]</title>

    <script>
        const session = JSON.parse(localStorage.getItem('sas_session'));
        if (!session || parseInt(session.rank) < 10) {
            alert("⛔ VIOLATION DE SÉCURITÉ : ACCÈS NIVEAU 10 REQUIS.");
            window.location.href = 'index.html';
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style-mo.css">

    <style>
        /* Styles spécifiques Admin */
        .admin-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;
        }
        .admin-table th {
            text-align: left; padding: 12px; color: var(--secondary);
            border-bottom: 2px solid var(--dim); letter-spacing: 2px;
        }
        .admin-table td {
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #ccc; vertical-align: middle;
        }
        .admin-table tr:hover { background: rgba(255,255,255,0.02); }

        .rank-control {
            display: flex; align-items: center; gap: 10px;
        }
        .rank-val {
            font-weight: bold; color: #fff; width: 30px; text-align: center;
        }
        .btn-mini {
            background: transparent; border: 1px solid var(--dim); color: var(--dim);
            width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-family: 'Share Tech Mono'; transition: 0.2s;
        }
        .btn-mini:hover { border-color: var(--primary); color: var(--primary); }

        .warn-badge {
            padding: 4px 8px; border-radius: 2px; font-weight: bold; font-size: 0.75rem;
            background: rgba(0,0,0,0.3); border: 1px solid #444; color: #888;
        }
        .warn-critic { color: var(--danger); border-color: var(--danger); background: rgba(255, 51, 51, 0.1); animation: blinkRed 2s infinite; }

        @keyframes blinkRed { 0%, 100% {opacity: 1;} 50% {opacity: 0.6;} }

        .btn-warn {
            border: 1px solid var(--warning); color: var(--warning);
            padding: 5px 10px; font-size: 0.7rem; background: transparent; cursor: pointer;
            font-family: 'Share Tech Mono'; text-transform: uppercase;
        }
        .btn-warn:hover { background: var(--warning); color: #000; }

        /* --- STYLES MODALE CORRIGÉS --- */
        .modal-overlay {
            position: fixed; /* Fixe par rapport à la fenêtre */
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.85); /* Fond sombre semi-transparent */
            backdrop-filter: blur(5px); /* Flou d'arrière-plan */
            z-index: 10000; /* Très haut pour être au-dessus de tout */
            display: flex; /* Utilise Flexbox pour centrer */
            justify-content: center; /* Centre horizontalement */
            align-items: center; /* Centre verticalement */
        }

        .hidden { display: none !important; }

        .modal-box {
            background: #0b0e11;
            border: 2px solid var(--danger); /* Bordure rouge pour l'admin */
            box-shadow: 0 0 50px rgba(255, 51, 51, 0.2); /* Ombre rouge */
            width: 500px; /* Largeur fixe */
            max-width: 90%;
            display: flex; flex-direction: column;
            position: relative; /* Pour le positionnement interne */
        }

        .modal-top {
            padding: 15px 25px;
            border-bottom: 1px solid #333;
            background: rgba(255, 51, 51, 0.1); /* Fond rouge très léger pour l'en-tête */
            display: flex; justify-content: space-between; align-items: center;
        }

        .modal-title {
            font-family: 'Share Tech Mono';
            color: var(--danger) !important;
            letter-spacing: 2px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Formulaire dans la modale */
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block; color: var(--secondary); font-size: 0.7rem; margin-bottom: 5px;
            font-family: 'Share Tech Mono';
        }
        .form-input, .form-textarea {
            width: 100%; background: #080a0c; border: 1px solid #444; color: #fff;
            padding: 10px; font-family: 'JetBrains Mono'; outline: none;
        }
        .form-input:focus, .form-textarea:focus { border-color: var(--danger); }

        .btn-tactical {
            background: transparent; border: 1px solid var(--primary); color: var(--primary);
            padding: 10px 20px; font-family: 'Share Tech Mono'; cursor: pointer;
            text-transform: uppercase; transition: 0.2s;
        }
        .btn-tactical.danger { border-color: var(--danger); color: var(--danger); }
        .btn-tactical.danger:hover { background: var(--danger); color: #000; }
        .btn-tactical.secondary { border-color: #666; color: #888; }
        .btn-tactical.secondary:hover { border-color: #fff; color: #fff; }

    </style>
</head>
<body>

<div class="crt-overlay"></div>

<div class="terminal-wrapper">
    <main class="terminal">

        <header class="header-strip">
            <div>
                <h1>COMMAND :: <span style="color: var(--danger);">OVERWATCH</span></h1>
                <div style="color: var(--dim); font-size: 0.9rem; letter-spacing: 3px;">ADMINISTRATION PERSONNEL</div>
            </div>
            <div class="meta-data">
                <div>ADMIN: <span style="color: var(--primary)" id="admin-name">...</span></div>
                <a href="index.html" style="color: var(--secondary); text-decoration: none;">[ RETOUR SYSTÈME ]</a>
            </div>
        </header>

        <section class="intel-grid" style="display: block; height: calc(100vh - 180px); overflow: hidden;">
            <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
                <div class="panel-header">
                    <span class="panel-title">LISTE DES AGENTS</span>
                    <div style="font-size: 0.7rem; color: #666;">LIVE DATABASE UPDATE</div>
                </div>

                <div style="overflow-y: auto; flex: 1;">
                    <table class="admin-table">
                        <thead>
                        <tr>
                            <th>AGENT</th>
                            <th>ID</th>
                            <th>HIÉRARCHIE (RANK)</th>
                            <th>DISCIPLINE (WARNS)</th>
                            <th style="text-align: right;">ACTIONS</th>
                        </tr>
                        </thead>
                        <tbody id="agents-list">
                        <tr><td colspan="5" style="text-align:center; padding:20px;">CHARGEMENT DES DONNÉES...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>
</div>

<div id="warn-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-top">
            <span class="modal-title">PROCÉDURE DISCIPLINAIRE</span>
            <button onclick="closeWarnModal()" style="background:none; border:none; color:#666; cursor:pointer; font-size: 1.2rem;">✖</button>
        </div>
        <form id="warn-form" style="padding: 25px;">
            <input type="hidden" id="warn-agent-id">
            <div class="form-group">
                <label>AGENT CIBLE</label>
                <input type="text" id="warn-agent-name" class="form-input" disabled style="opacity: 0.7; border-color: #333;">
            </div>
            <div class="form-group">
                <label>MOTIF DE L'AVERTISSEMENT</label>
                <textarea id="warn-reason" class="form-textarea" style="height:100px;" placeholder="Ex: Insubordination lors de l'OP Blackout..."></textarea>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button type="button" onclick="closeWarnModal()" class="btn-tactical secondary">ANNULER</button>
                <button type="submit" class="btn-tactical danger">CONFIRMER SANCTION</button>
            </div>
        </form>
    </div>
</div>

<script>
    const token = localStorage.getItem('sas_token');
    const currentUser = JSON.parse(localStorage.getItem('sas_session'));
    document.getElementById('admin-name').textContent = currentUser.username.toUpperCase();

    document.addEventListener('DOMContentLoaded', loadAgents);

    async function loadAgents() {
        try {
            const res = await fetch('/api/admin', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.status === 403) {
                alert("ACCÈS REFUSÉ");
                window.location.href = 'index.html';
                return;
            }

            const agents = await res.json();
            renderTable(agents);
        } catch (e) {
            console.error(e);
            document.getElementById('agents-list').innerHTML = `<tr><td colspan="5" style="color:var(--danger); text-align:center;">ERREUR DE CONNEXION SERVEUR</td></tr>`;
        }
    }

    function renderTable(agents) {
        const tbody = document.getElementById('agents-list');
        tbody.innerHTML = '';

        agents.forEach(agent => {
            const warnCount = parseInt(agent.warn_count);
            let warnHtml = `<span class="warn-badge">✅ 0/3</span>`;

            if (warnCount > 0 && warnCount < 3) {
                warnHtml = `<span class="warn-badge" style="color:var(--warning); border-color:var(--warning)">⚠️ ${warnCount}/3</span>`;
            } else if (warnCount >= 3) {
                warnHtml = `<span class="warn-badge warn-critic">☠️ ${warnCount}/3 CRITIQUE</span>`;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                    <td style="font-weight:bold; color:#fff;">${agent.username.toUpperCase()}</td>
                    <td style="font-family:'Share Tech Mono'; color:#666;">#${agent.id}</td>
                    <td>
                        <div class="rank-control">
                            <button class="btn-mini" onclick="updateRank(${agent.id}, ${agent.rank}, -1)">-</button>
                            <span class="rank-val" style="color:${getRankColor(agent.rank)}">${agent.rank}</span>
                            <button class="btn-mini" onclick="updateRank(${agent.id}, ${agent.rank}, 1)">+</button>
                        </div>
                    </td>
                    <td>${warnHtml}</td>
                    <td style="text-align: right;">
                        <button class="btn-warn" onclick="openWarnModal(${agent.id}, '${agent.username}')">[ ! WARN ]</button>
                    </td>
                `;
            tbody.appendChild(row);
        });
    }

    function getRankColor(rank) {
        if(rank >= 10) return 'var(--danger)';
        if(rank >= 5) return 'var(--warning)';
        if(rank >= 3) return 'var(--secondary)';
        return 'var(--primary)';
    }

    async function updateRank(id, currentRank, change) {
        const newRank = parseInt(currentRank) + change;
        if(newRank < 0) return;

        try {
            const res = await fetch('/api/admin', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ agent_id: id, new_rank: newRank })
            });

            if(res.ok) {
                loadAgents();
            } else {
                alert("Erreur lors de la mise à jour du grade.");
            }
        } catch(e) { console.error(e); }
    }


    function openWarnModal(id, username) {
        document.getElementById('warn-agent-id').value = id;
        document.getElementById('warn-agent-name').value = username.toUpperCase();
        document.getElementById('warn-reason').value = '';

        // On s'assure que la classe hidden est bien retirée
        const modal = document.getElementById('warn-modal');
        modal.classList.remove('hidden');
        // Force le style flex si le CSS a du mal à prendre le dessus
        modal.style.display = 'flex';
    }

    function closeWarnModal() {
        const modal = document.getElementById('warn-modal');
        modal.classList.add('hidden');
        modal.style.display = 'none'; // Sécurité supplémentaire
    }

    document.getElementById('warn-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('warn-agent-id').value;
        const reason = document.getElementById('warn-reason').value;

        if(!reason.trim()) { alert("Le motif est obligatoire."); return; }

        try {
            const res = await fetch('/api/admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ agent_id: id, reason: reason })
            });

            if(res.ok) {
                closeWarnModal();
                loadAgents();
            } else {
                alert("Erreur lors de l'ajout de l'avertissement.");
            }
        } catch(e) { console.error(e); }
    });

</script>
</body>
</html>