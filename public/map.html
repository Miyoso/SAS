<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - TACTICAL MAP V2</title>
    
    <script>
        const session = localStorage.getItem('sas_session');
        // if (!session) window.location.href = 'index.html';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style-mo.css">

    <style>
        body { overflow: hidden; background: #050505; }

        /* --- LAYOUT --- */
        .map-wrapper {
            display: flex; height: 100vh; width: 100vw;
            position: relative;
        }

        /* --- CONTAINER CARTE (ZOOMABLE) --- */
        .viewport {
            flex: 1;
            background: #0a0a0a;
            overflow: hidden;
            position: relative;
            cursor: grab;
            /* Grille de fond fixe par rapport √† la fen√™tre */
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .viewport:active { cursor: grabbing; }

        /* C'est cet √©l√©ment qui va bouger et zoomer */
        .transform-layer {
            position: absolute; top: 0; left: 0;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out; /* Fluidit√© */
        }

        .tactical-map {
            display: block;
            pointer-events: none; /* On clique au travers de l'image */
            filter: contrast(1.1) grayscale(0.3) brightness(0.7);
        }

        /* --- INTERFACE HUD (SIDEBAR FLOTTANTE) --- */
        .sidebar-overlay {
            position: absolute; top: 20px; right: 20px; bottom: 20px; width: 350px;
            display: flex; flex-direction: column; gap: 15px; pointer-events: none;
        }
        .panel {
            background: rgba(10, 15, 20, 0.9);
            border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(10px); padding: 15px;
            pointer-events: auto; /* R√©active les clics */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .panel-title {
            font-family: 'Share Tech Mono'; color: var(--primary); font-size: 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 10px;
            display: flex; justify-content: space-between;
        }

        /* BOUTONS OUTILS */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .tool-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #ccc; padding: 12px; cursor: pointer; font-family: 'JetBrains Mono'; font-size: 0.75rem;
            display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tool-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 255, 157, 0.1); box-shadow: 0 0 15px rgba(0, 255, 157, 0.1); }
        .tool-icon { font-size: 1.2rem; }

        /* ZOOM CONTROLS */
        .zoom-controls {
            position: absolute; bottom: 20px; left: 20px;
            display: flex; gap: 5px; pointer-events: auto;
        }
        .zoom-btn {
            width: 40px; height: 40px; background: #000; border: 1px solid var(--primary);
            color: var(--primary); font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .zoom-btn:hover { background: var(--primary); color: #000; }

        /* --- FORMES TACTIQUES CSS --- */
        .map-marker { position: absolute; transform: translate(-50%, -50%); z-index: 100; cursor: pointer; }
        .map-marker:hover { z-index: 200; filter: brightness(1.5); }

        /* Label texte */
        .marker-label {
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 2px 6px; border-radius: 4px;
            font-size: 0.6rem; color: #fff; white-space: nowrap; margin-top: 5px;
            border: 1px solid currentColor; display: none;
        }
        .map-marker:hover .marker-label { display: block; }

        /* Formes de base */
        .shape { width: 100%; height: 100%; opacity: 0.5; transition: 0.3s; }
        
        /* 1. CERCLE (Zone standard) */
        .type-circle .shape {
            border-radius: 50%; border: 2px dashed currentColor; background: radial-gradient(circle, currentColor 0%, transparent 70%);
        }
        
        /* 2. CARR√â (Zone fortifi√©e / Batiment) */
        .type-square .shape {
            border: 2px solid currentColor; background: linear-gradient(45deg, currentColor 0%, transparent 20%, transparent 80%, currentColor 100%);
        }

        /* 3. HEXAGONE (QG / Point strat√©gique) */
        .type-hex .shape {
            background: currentColor; opacity: 0.3;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        }
        .type-hex::after { /* Contour Hex */
            content:''; position:absolute; top:0; left:0; width:100%; height:100%;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            background: currentColor; z-index:-1; transform: scale(1.05); opacity: 0.8;
        }

        /* 4. LIGNE (Direction / Fronti√®re) */
        .type-line {
            /* Pour la ligne, on triche : c'est un rectangle tr√®s fin et long */
            height: 6px !important; /* √âcrase la hauteur dynamique */
            border-radius: 3px;
        }
        .type-line .shape {
            background: currentColor; opacity: 0.8; box-shadow: 0 0 10px currentColor;
        }

        /* Couleurs Niveaux */
        .lvl-low { color: #00ff9d; }
        .lvl-mid { color: #eebb00; }
        .lvl-high { color: #ff3333; }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box { background: #0f1215; border: 1px solid var(--primary); padding: 25px; width: 350px; }
        .input-field { width: 100%; background: #050505; border: 1px solid #444; color: #fff; padding: 8px; margin-top: 5px; font-family: 'JetBrains Mono'; }

    </style>
</head>
<body>

    <div class="crt-overlay"></div>

    <div class="map-wrapper">
        
        <div class="viewport" id="viewport">
            <div class="transform-layer" id="map-layer">
                <img src="assets/carte.jpg" class="tactical-map" id="tactical-map" alt="Map">
                <div id="markers-container"></div>
            </div>
        </div>

        <div class="zoom-controls">
            <div class="zoom-btn" onclick="adjustZoom(0.2)">+</div>
            <div class="zoom-btn" onclick="adjustZoom(-0.2)">-</div>
            <div class="zoom-btn" onclick="resetView()" style="font-size:0.7rem">RST</div>
        </div>

        <div class="sidebar-overlay">
            
            <div class="panel">
                <div class="panel-title">
                    <span>OPERATION MAP</span>
                    <span id="coords-display" style="color:#fff">000, 000</span>
                </div>
                <div style="font-size:0.7rem; color:#888;">
                    <a href="index.html" style="color:var(--primary); text-decoration:none;">< RETOUR DASHBOARD</a>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">PALETTE TACTIQUE</div>
                <div class="tools-grid">
                    <div class="tool-btn active" onclick="setTool('pointer')">
                        <span class="tool-icon">‚úã</span> NAV
                    </div>
                    <div class="tool-btn" onclick="setTool('point')">
                        <span class="tool-icon">üìç</span> POINT
                    </div>
                    <div class="tool-btn" onclick="setTool('circle')">
                        <span class="tool-icon">‚≠ï</span> ZONE (ROND)
                    </div>
                    <div class="tool-btn" onclick="setTool('square')">
                        <span class="tool-icon">üî≤</span> ZONE (CARR√â)
                    </div>
                    <div class="tool-btn" onclick="setTool('hex')">
                        <span class="tool-icon">‚¨¢</span> HEXAGONE
                    </div>
                    <div class="tool-btn" onclick="setTool('line')">
                        <span class="tool-icon">‚ûñ</span> LIGNE
                    </div>
                </div>
                <div style="margin-top:10px; font-size:0.65rem; color:#666;">
                    * S√©lectionnez un outil puis cliquez sur la carte.
                </div>
            </div>

            <div class="panel" style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
                <div class="panel-title">RAPPORT LIVE</div>
                <div id="intel-feed" style="overflow-y:auto; flex:1; font-size:0.75rem; color:#aaa;">
                    Chargement...
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="add-modal">
        <div class="modal-box">
            <h3 style="color:var(--primary); margin-bottom:15px;">CONFIGURER √âL√âMENT</h3>
            
            <div style="margin-bottom:15px;">
                <label style="font-size:0.7rem; color:#888;">DESCRIPTION</label>
                <input type="text" id="inp-desc" class="input-field" placeholder="Ex: Ennemis, Objectif..." autocomplete="off">
            </div>

            <div style="margin-bottom:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label style="font-size:0.7rem; color:#888;">MENACE</label>
                    <select id="inp-level" class="input-field">
                        <option value="low">FAIBLE (Vert)</option>
                        <option value="mid">MOYEN (Jaune)</option>
                        <option value="high">CRITIQUE (Rouge)</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.7rem; color:#888;">TAILLE (PX)</label>
                    <input type="number" id="inp-size" class="input-field" value="100" min="20" max="500">
                </div>
            </div>

            <div style="margin-bottom:15px;" id="group-rotation">
                <label style="font-size:0.7rem; color:#888;">ROTATION (DEGR√âS)</label>
                <input type="range" id="inp-rot" class="input-field" min="0" max="360" value="0" oninput="document.getElementById('rot-val').innerText = this.value + '¬∞'">
                <div style="text-align:right; font-size:0.7rem; color:var(--secondary);" id="rot-val">0¬∞</div>
            </div>

            <input type="hidden" id="inp-x">
            <input type="hidden" id="inp-y">
            <input type="hidden" id="inp-type">

            <button onclick="confirmAdd()" class="tool-btn active" style="width:100%; justify-content:center;">CONFIRMER</button>
            <button onclick="closeModal()" class="tool-btn" style="width:100%; margin-top:5px; justify-content:center;">ANNULER</button>
        </div>
    </div>

    <script>
        // --- 1. GESTION ZOOM & PAN ---
        let scale = 1;
        let panning = false;
        let pointX = 0;
        let pointY = 0;
        let startX = 0;
        let startY = 0;

        const viewport = document.getElementById('viewport');
        const mapLayer = document.getElementById('map-layer');
        
        // Initialisation Zoom
        function updateTransform() {
            mapLayer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        }

        viewport.addEventListener('mousedown', (e) => {
            if (currentTool !== 'pointer') return; // Seulement en mode Nav
            if (e.target.closest('.map-marker')) return; // Pas si on clique sur un marqueur
            panning = true;
            startX = e.clientX - pointX;
            startY = e.clientY - pointY;
            viewport.style.cursor = 'grabbing';
        });

        window.addEventListener('mouseup', () => {
            panning = false;
            if(currentTool === 'pointer') viewport.style.cursor = 'grab';
        });

        window.addEventListener('mousemove', (e) => {
            if (panning) {
                e.preventDefault();
                pointX = e.clientX - startX;
                pointY = e.clientY - startY;
                updateTransform();
            }
            // Mise √† jour coordonn√©es HUD (visuel)
            document.getElementById('coords-display').innerText = `${e.clientX}, ${e.clientY}`;
        });

        // Zoom Roulette
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const xs = (e.clientX - pointX) / scale;
            const ys = (e.clientY - pointY) / scale;
            const delta = -e.deltaY;
            
            (delta > 0) ? (scale *= 1.1) : (scale /= 1.1);
            
            // Limites Zoom
            if (scale < 0.2) scale = 0.2;
            if (scale > 5) scale = 5;

            pointX = e.clientX - xs * scale;
            pointY = e.clientY - ys * scale;

            updateTransform();
        });

        function adjustZoom(amount) {
            scale += amount;
            if (scale < 0.2) scale = 0.2;
            updateTransform();
        }
        function resetView() {
            scale = 1; pointX = 0; pointY = 0;
            updateTransform();
        }

        // --- 2. LOGIQUE OUTILS & MARQUEURS ---
        let currentTool = 'pointer';
        let markers = [];
        
        // Elements
        const markersContainer = document.getElementById('markers-container');
        const modal = document.getElementById('add-modal');
        const intelFeed = document.getElementById('intel-feed');

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(tool === 'pointer') {
                viewport.style.cursor = 'grab';
            } else {
                viewport.style.cursor = 'crosshair';
            }
        }

        // Clic pour ajouter (g√©r√© sur le mapLayer pour suivre les coordonn√©es de l'image, pas de l'√©cran)
        mapLayer.addEventListener('click', (e) => {
            if (currentTool === 'pointer') return;
            if (panning) return; // √âvite d'ajouter si on glisse juste
            if (e.target.closest('.map-marker')) return;

            // Coordonn√©es relatives √† l'image (pour que le marqueur reste au bon endroit quand on zoom/pan)
            const rect = mapLayer.getBoundingClientRect();
            const clickX = (e.clientX - rect.left) / scale; // On compense le scale
            const clickY = (e.clientY - rect.top) / scale;

            openModal(clickX, clickY, currentTool);
        });

        function openModal(x, y, type) {
            document.getElementById('inp-x').value = x;
            document.getElementById('inp-y').value = y;
            document.getElementById('inp-type').value = type;
            document.getElementById('inp-desc').value = '';
            document.getElementById('inp-desc').focus();

            // R√©glages par d√©faut selon type
            if (type === 'point') {
                document.getElementById('inp-size').value = 20;
                document.getElementById('group-rotation').style.display = 'none';
            } else if (type === 'line') {
                document.getElementById('inp-size').value = 200; // Longueur
                document.getElementById('group-rotation').style.display = 'block';
            } else {
                document.getElementById('inp-size').value = 150; // Taille zone
                document.getElementById('group-rotation').style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        function closeModal() { modal.style.display = 'none'; }

        // --- 3. COMMUNICATION BDD ---
        async function fetchMarkers() {
            try {
                const res = await fetch('/api/markers');
                if(res.ok) {
                    markers = await res.json();
                    renderMarkers();
                    updateFeed();
                }
            } catch(e) { console.error(e); }
        }

        async function confirmAdd() {
            const data = {
                x: document.getElementById('inp-x').value,
                y: document.getElementById('inp-y').value,
                type: document.getElementById('inp-type').value,
                desc: document.getElementById('inp-desc').value || 'Cible',
                level: document.getElementById('inp-level').value,
                // Donn√©es suppl√©mentaires pour formes
                rotation: document.getElementById('inp-rot').value || 0,
                scale: document.getElementById('inp-size').value || 100, // On utilise scale pour stocker la taille en px
                author: JSON.parse(localStorage.getItem('sas_session'))?.username || 'Unknown'
            };

            try {
                await fetch('/api/markers', {
                    method: 'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(data)
                });
                closeModal();
                fetchMarkers();
            } catch(e) { alert("Erreur r√©seau"); }
        }

        async function deleteMarker(id) {
            if(confirm("SUPPRIMER CET √âL√âMENT ?")) {
                await fetch('/api/markers', {
                    method: 'DELETE', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({id})
                });
                fetchMarkers();
            }
        }

       // --- 4. RENDU OPTIMIS√â ---
        function renderMarkers() {
            if(!markersLayer) return;
            markersLayer.innerHTML = '';
            
            markers.forEach(m => {
                const el = document.createElement('div');
                
                // S√©curisation des donn√©es
                const safeType = m.type || 'point';
                const safeLevel = m.level || 'low';
                const safeRotation = m.rotation || 0;
                
                // Classes CSS
                el.className = `map-marker type-${safeType} lvl-${safeLevel}`;
                
                // Positionnement
                el.style.left = m.x + '%';
                el.style.top = m.y + '%';
                
                // Taille (Scale)
                // Pour un point, on ignore le scale pour garder une taille fixe (sauf si vous voulez des gros points)
                const baseSize = (safeType === 'point') ? 20 : 100; 
                const size = m.scale || baseSize;
                
                el.style.width = size + 'px';
                el.style.height = size + 'px';
                
                // Rotation & Centrage (On √©crase proprement le transform)
                // Note: Pour une ligne, la rotation est essentielle
                el.style.transform = `translate(-50%, -50%) rotate(${safeRotation}deg)`;

                // Contenu visuel interne
                let inner = '';
                if(safeType === 'point') {
                    // Point simple (rond lumineux)
                    inner = `<div style="width:100%; height:100%; border-radius:50%; background:currentColor; box-shadow:0 0 10px currentColor;"></div>`;
                } else {
                    // Formes (G√©r√©es par le CSS .shape)
                    inner = `<div class="shape"></div>`;
                }

                // Tooltip au survol
                const safeDesc = m.description || m.desc || 'Inconnu';
                const safeAuthor = m.author || 'Syst√®me';
                
                inner += `
                    <div class="marker-label">
                        <span style="font-weight:bold; color:#fff">${safeDesc}</span><br>
                        <span style="opacity:0.7; font-size:0.55rem">OPT: ${safeAuthor}</span>
                        <div style="margin-top:3px; border-top:1px solid #555; padding-top:2px; text-align:center;">
                            <span style="color:#ff5555; cursor:pointer;" onclick="deleteMarker(${m.id})">SUPPRIMER</span>
                        </div>
                    </div>
                `;

                el.innerHTML = inner;
                markersLayer.appendChild(el);
            });
        }

        function updateFeed() {
            intelFeed.innerHTML = '';
            if(markers.length === 0) intelFeed.innerHTML = '<div style="padding:10px;">Aucune donn√©e.</div>';
            
            [...markers].reverse().forEach(m => {
                const div = document.createElement('div');
                div.style.padding = '8px';
                div.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                div.style.cursor = 'pointer';
                div.onclick = () => {
                    // Focus sur le point (reset zoom simple)
                    scale = 1.5;
                    pointX = -m.x * scale + viewport.clientWidth/2;
                    pointY = -m.y * scale + viewport.clientHeight/2;
                    updateTransform();
                };

                let icon = 'üìç';
                if(m.type === 'circle') icon = '‚≠ï';
                if(m.type === 'square') icon = 'üî≤';
                if(m.type === 'line') icon = '‚ûñ';
                if(m.type === 'hex') icon = '‚¨¢';

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; color:var(--primary);">
                        <span>${icon} ${m.desc}</span>
                    </div>
                    <div style="color:#666;">${m.author} // ${m.level.toUpperCase()}</div>
                `;
                intelFeed.appendChild(div);
            });
        }

        // D√©marrage
        document.addEventListener('DOMContentLoaded', () => {
            fetchMarkers();
            setInterval(fetchMarkers, 3000); // Temps r√©el
        });

    </script>
</body>
</html>