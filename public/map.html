<script>
        // VARIABLES GLOBALES
        let currentTool = 'pointer';
        let markers = []; // On part d'une liste vide, on la remplira via l'API
        const mapContainer = document.getElementById('map-container');
        const markersLayer = document.getElementById('markers-layer');
        const modal = document.getElementById('add-modal');
        const intelList = document.getElementById('intel-list');

        // INITIALISATION
        document.addEventListener('DOMContentLoaded', () => {
            fetchMarkers(); // Premier chargement
            
            // SYST√àME "TEMPS R√âEL" (POLLING)
            // Rafra√Æchit les donn√©es toutes les 3 secondes pour voir les changements des autres
            setInterval(fetchMarkers, 3000);
        });

        // --- COMMUNICATION AVEC LA BDD ---

        // 1. R√âCUP√âRER (GET)
        async function fetchMarkers() {
            try {
                const response = await fetch('/api/markers');
                if (response.ok) {
                    markers = await response.json();
                    renderMap();
                    updateIntelList();
                }
            } catch (e) {
                console.error("Erreur de connexion tactique:", e);
            }
        }

        // 2. AJOUTER (POST)
        async function pushMarkerToDB(newMarker) {
            try {
                await fetch('/api/markers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        x: newMarker.x,
                        y: newMarker.y,
                        type: newMarker.type,
                        desc: newMarker.desc,
                        level: newMarker.level,
                        author: newMarker.author
                    })
                });
                fetchMarkers(); // On recharge imm√©diatement pour voir le r√©sultat confirm√©
            } catch (e) {
                alert("ERREUR DE TRANSMISSION AU QG.");
            }
        }

        // 3. SUPPRIMER (DELETE)
        async function deleteMarkerFromDB(id) {
            try {
                await fetch('/api/markers', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                fetchMarkers();
            } catch (e) {
                alert("IMPOSSIBLE DE SUPPRIMER LA CIBLE.");
            }
        }

        // --- LOGIQUE D'INTERFACE (Inchang√©e ou adapt√©e) ---

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            // Note: l'event est pass√© implicitement, attention si appel√© sans event
            if(event) event.currentTarget.classList.add('active');
            
            if (tool === 'pointer') mapContainer.style.cursor = 'grab';
            else mapContainer.style.cursor = 'crosshair';
        }

        mapContainer.addEventListener('click', (e) => {
            if (currentTool === 'pointer') return;
            if (e.target.closest('.map-marker')) return;

            const rect = mapContainer.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            openModal(x, y, currentTool);
        });

        function openModal(x, y, type) {
            document.getElementById('input-x').value = x;
            document.getElementById('input-y').value = y;
            document.getElementById('input-type').value = type;
            document.getElementById('input-desc').value = '';
            document.getElementById('input-level').value = 'low';
            modal.style.display = 'flex';
            document.getElementById('input-desc').focus();
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function confirmAdd() {
            const desc = document.getElementById('input-desc').value || 'Point Inconnu';
            const level = document.getElementById('input-level').value;
            const type = document.getElementById('input-type').value;
            const x = document.getElementById('input-x').value;
            const y = document.getElementById('input-y').value;
            
            const session = localStorage.getItem('sas_session');
            const author = session ? JSON.parse(session).username : 'Unknown';

            // On envoie √† la BDD au lieu du tableau local
            pushMarkerToDB({ x, y, type, desc, level, author });
            
            closeModal();
        }

        function renderMap() {
            markersLayer.innerHTML = '';
            markers.forEach(m => {
                const el = document.createElement('div');
                // Note: m.level vient de la BDD, assurez-vous que c'est bien 'low', 'mid', 'high'
                el.className = `map-marker level-${m.level}`;
                el.style.left = m.x + '%';
                el.style.top = m.y + '%';
                
                let innerHTML = '';
                if(m.type === 'zone') {
                    innerHTML = `
                        <div class="marker-zone" style="background: radial-gradient(circle, currentColor 0%, transparent 70%);"></div>
                        <div class="marker-icon" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:10px; height:10px;"></div>
                    `;
                } else {
                    innerHTML = `<div class="marker-icon"></div>`;
                }

                // Ajout de l'ID pour la suppression
                innerHTML += `<div class="marker-tooltip">
                    <strong style="color:var(--primary)">${m.description || m.desc}</strong><br>
                    <span style="font-size:0.6rem">PAR: ${m.author}</span><br>
                    <span style="color:#888; cursor:pointer;" onclick="deleteMarker(${m.id})">[SUPPRIMER]</span>
                </div>`;

                el.innerHTML = innerHTML;
                markersLayer.appendChild(el);
            });
        }

        function updateIntelList() {
            intelList.innerHTML = '';
            if(markers.length === 0) {
                intelList.innerHTML = '<div style="padding:10px; color:#666;">AUCUN RAPPORT D\'ACTIVIT√â.</div>';
                return;
            }
            // On inverse pour avoir les plus r√©cents en haut
            [...markers].reverse().forEach(m => {
                const item = document.createElement('div');
                item.className = `intel-item bg-${m.level}`;
                const icon = m.type === 'zone' ? '‚≠ï' : 'üìç';
                // Gestion date format
                const dateStr = m.created_at ? new Date(m.created_at).toLocaleTimeString() : 'UNKNOWN';
                
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${icon} ${m.description || m.desc}</strong>
                        <span style="font-size:0.65rem; opacity:0.7;">${dateStr}</span>
                    </div>
                    <div style="font-size:0.7rem; color:#aaa; margin-top:2px;">
                        MENACE: ${m.level.toUpperCase()} // AGENT: ${m.author}
                    </div>
                `;
                intelList.appendChild(item);
            });
        }

        // Fonction globale pour le onclick dans le HTML g√©n√©r√©
        window.deleteMarker = function(id) {
            if(confirm("CONFIRMER LA SUPPRESSION DE CE MARQUEUR ?")) {
                deleteMarkerFromDB(id);
            }
        };

        function clearMap() {
            alert("Fonction d√©sactiv√©e pour s√©curit√© globale. Supprimez les points individuellement.");
            // Pour r√©activer, il faudrait une route API DELETE ALL, dangereux pour une √©quipe.
        }
    </script>