<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - TACTICAL TRAINING</title>

    <script>
        if (!localStorage.getItem('sas_session')) window.location.href = 'index.html';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style-mo.css">

    <style>
        /* --- CSS SPÉCIFIQUE ARCADE --- */

        .arcade-container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
            height: calc(100vh - 160px);
        }

        /* ZONE DE JEU */
        .game-viewport {
            background: rgba(5, 8, 10, 0.8);
            border: 2px solid var(--dim);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            cursor: crosshair; /* Curseur de visée */
        }

        /* Feedback visuel quand on rate (flash rouge) */
        .game-viewport.miss-flash {
            animation: flashRed 0.2s ease-out;
        }
        @keyframes flashRed {
            0% { box-shadow: inset 0 0 0 transparent; border-color: var(--dim); }
            50% { box-shadow: inset 0 0 100px var(--danger); border-color: var(--danger); }
            100% { box-shadow: inset 0 0 0 transparent; border-color: var(--dim); }
        }

        /* Indicateur de pénalité (-50) */
        .floating-penalty {
            position: absolute;
            color: var(--danger);
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            font-family: 'Share Tech Mono';
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        .game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
            transition: opacity 0.3s;
        }
        .hidden-overlay { opacity: 0; pointer-events: none; }

        .game-title { font-size: 3rem; color: var(--primary); text-shadow: 0 0 20px var(--primary); margin-bottom: 20px; font-weight: 800; letter-spacing: 5px; }

        /* HUD Score et Vitesse */
        .hud-top-right { position: absolute; top: 20px; right: 30px; text-align: right; pointer-events: none; }
        .game-score-display { font-size: 2rem; color: #fff; font-family: 'Share Tech Mono'; }
        .speed-indicator { font-size: 0.8rem; color: var(--warning); letter-spacing: 1px; margin-top: 5px; }

        .lives-display { position: absolute; top: 20px; left: 30px; display: flex; gap: 10px; pointer-events: none; }
        .life-pip { width: 15px; height: 15px; background: var(--danger); box-shadow: 0 0 10px var(--danger); transform: rotate(45deg); transition: 0.3s; }
        .life-lost { background: #333; box-shadow: none; border: 1px solid #555; }

        /* NŒUDS DU JEU (CIBLES) */
        .node-target {
            position: absolute;
            width: 60px; height: 60px;
            border: 2px solid var(--primary);
            background: rgba(0, 255, 157, 0.15);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: var(--primary);
            animation: spawnPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 15px var(--primary);
            clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%);
            user-select: none;
        }
        .node-target:hover { background: rgba(0, 255, 157, 0.3); }
        .node-target::before { content: ''; position: absolute; width: 100%; height: 100%; border: 1px solid rgba(255,255,255,0.2); animation: spin 4s linear infinite; }

        @keyframes spawnPop { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* LEADERBOARD */
        .leaderboard-panel {
            background: rgba(15, 20, 25, 0.6);
            border: 1px solid var(--primary);
            display: flex; flex-direction: column;
        }
        .rank-row {
            display: flex; justify-content: space-between; padding: 12px;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            font-family: 'Share Tech Mono';
        }
        .rank-1 { color: #d4af37; text-shadow: 0 0 10px #d4af37; font-weight: bold; background: rgba(212, 175, 55, 0.05); }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; }

        .btn-game {
            background: transparent; border: 2px solid var(--primary); color: var(--primary);
            padding: 15px 40px; font-size: 1.2rem; cursor: pointer; font-family: 'Share Tech Mono';
            text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .btn-game:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }

        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(0, 255, 157, 0.3); opacity: 0.5; pointer-events: none;
            animation: scanDown 3s linear infinite; z-index: 5;
        }
        @keyframes scanDown { 0% {top:0;} 100% {top:100%;} }

    </style>
</head>
<body>

    <div class="crt-overlay"></div>

    <div class="terminal-wrapper">
        <main class="terminal">

            <header class="header-strip">
                <div>
                    <h1>TRAINING :: <span style="color: var(--primary);">SIMULATION</span></h1>
                    <div style="color: var(--dim); font-size: 0.9rem; letter-spacing: 3px;">SHADOW COMPANY // REFLEX TEST</div>
                </div>
                <div class="meta-data">
                    <div>MODULE: SYSTEM_BREACH_V2</div>
                    <a href="index.html" style="color: var(--secondary); text-decoration: none;">[ RETOUR ]</a>
                </div>
            </header>

            <div class="arcade-container">

                <div class="game-viewport" id="game-area">
                    <div class="scan-line"></div>

                    <div class="hud-top-right">
                        <div class="game-score-display">SCORE: <span id="current-score">0</span></div>
                        <div class="speed-indicator" id="speed-display">VITESSE: 100%</div>
                    </div>

                    <div class="lives-display" id="lives-container">
                        <div class="life-pip"></div>
                        <div class="life-pip"></div>
                        <div class="life-pip"></div>
                    </div>

                    <div id="game-overlay" class="game-overlay">
                        <div class="game-title" id="overlay-title">SYSTEM BREACH</div>
                        <div style="margin-bottom: 30px; text-align: center; color: #aaa; font-family: 'JetBrains Mono'; font-size: 0.9rem; line-height: 1.6;">
                            <span style="color:#fff">MISSION :</span> CLIQUEZ SUR LES CIBLES.<br>
                            <span style="color:var(--danger)">ATTENTION :</span> -50 PTS SI VOUS RATEZ.<br>
                            LA VITESSE AUGMENTE AVEC LE TEMPS.
                        </div>
                        <div id="final-score-display" style="font-size: 1.5rem; color: #fff; margin-bottom: 20px; display: none;">
                            SCORE FINAL: <span style="color:var(--primary)">0</span>
                        </div>
                        <button class="btn-game" onclick="startGame()">LANCER SIMULATION</button>
                    </div>

                </div>

                <div class="leaderboard-panel panel">
                    <div class="panel-header">
                        <span class="panel-title" style="color:var(--warning)">TOP OPERATORS</span>
                        <span style="font-size:0.7rem;">GLOBAL_RANK</span>
                    </div>
                    <div id="leaderboard-list" style="flex: 1; overflow-y: auto;">
                        <div style="padding: 20px; text-align: center; color: #666;" class="blink">CONNEXION SERVEUR...</div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GameConfig = {
            startSpawnRate: 1200,   // Vitesse de départ (ms)
            minSpawnRate: 350,      // Vitesse max (ms)
            speedUpStep: 50,        // Accélération (ms en moins)
            speedUpInterval: 5000,  // Accélère toutes les 5 secondes
            scoreHit: 100,          // Points par cible
            scoreMiss: 50           // Pénalité tir raté
        };

        let gameState = {
            active: false,
            score: 0,
            lives: 3,
            currentRate: GameConfig.startSpawnRate,
            gameTimer: null,
            difficultyTimer: null,
            spawnTimeout: null
        };

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'hit') {
                // Son laser rapide
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1500, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'miss') {
                // Son buzzer erreur (grave)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'start') {
                // Son montée en puissance
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.5);
                gain.gain.setValueAtTime(0.05, now);
                osc.start(now);
                osc.stop(now + 0.5);
            }
        }

        // --- GAME LOGIC ---

        function startGame() {
            playSound('start');

            // Reset variables
            gameState.active = true;
            gameState.score = 0;
            gameState.lives = 3;
            gameState.currentRate = GameConfig.startSpawnRate;

            // Reset UI
            document.getElementById('game-overlay').classList.add('hidden-overlay');
            updateScoreUI();
            updateLivesUI();
            updateSpeedUI();

            // Nettoyage plateau
            document.querySelectorAll('.node-target').forEach(n => n.remove());
            document.querySelectorAll('.floating-penalty').forEach(n => n.remove());

            // Boucle de Jeu
            gameLoop();

            // Boucle de Difficulté (Basée sur le TEMPS)
            gameState.difficultyTimer = setInterval(() => {
                if (gameState.currentRate > GameConfig.minSpawnRate) {
                    gameState.currentRate -= GameConfig.speedUpStep;
                    updateSpeedUI();
                }
            }, GameConfig.speedUpInterval);
        }

        function gameLoop() {
            if (!gameState.active) return;

            spawnNode();

            // Le prochain spawn dépend du currentRate qui diminue avec le temps
            gameState.spawnTimeout = setTimeout(gameLoop, gameState.currentRate);
        }

        function spawnNode() {
            const gameArea = document.getElementById('game-area');
            const node = document.createElement('div');
            node.classList.add('node-target');

            // Position aléatoire sécurisée
            const maxX = gameArea.clientWidth - 70;
            const maxY = gameArea.clientHeight - 70;
            const x = Math.floor(Math.random() * maxX);
            const y = Math.floor(Math.random() * maxY);

            node.style.left = x + 'px';
            node.style.top = y + 'px';
            node.innerText = Math.floor(Math.random()*99).toString().padStart(2, '0');

            // --- ÉVÉNEMENT : CIBLE TOUCHÉE ---
            node.onmousedown = (e) => {
                if (!gameState.active) return;
                e.stopPropagation(); // EMPÊCHE DE DÉCLENCHER LE CLICK SUR LE FOND

                playSound('hit');
                gameState.score += GameConfig.scoreHit;
                updateScoreUI();

                // Effet de destruction
                node.style.background = '#fff';
                node.style.transform = 'scale(1.5)';
                node.style.opacity = '0';
                setTimeout(() => node.remove(), 100);

                // Annuler la punition de disparition
                clearTimeout(node.despawnTimer);
            };

            gameArea.appendChild(node);

            // Disparition automatique (Trop lent)
            // Plus c'est rapide, plus les cibles disparaissent vite aussi
            const lifeTime = Math.max(800, gameState.currentRate * 1.5);

            node.despawnTimer = setTimeout(() => {
                if (node.parentNode) {
                    node.remove();
                    // Une cible manquée (disparue) ne retire pas de points, mais une vie
                    loseLife();
                }
            }, lifeTime);
        }

        // --- GESTION DU "CLICK À CÔTÉ" ---
        document.getElementById('game-area').onmousedown = (e) => {
            if (!gameState.active) return;

            // Si on arrive ici, c'est qu'on a cliqué sur le fond (grâce au stopPropagation sur les cibles)
            playSound('miss');

            // Pénalité Score
            gameState.score = Math.max(0, gameState.score - GameConfig.scoreMiss);
            updateScoreUI();

            // Feedback Visuel (Flash Rouge)
            const area = document.getElementById('game-area');
            area.classList.remove('miss-flash');
            void area.offsetWidth; // Reflow hack pour restart animation
            area.classList.add('miss-flash');

            // Indicateur flottant "-50"
            showFloatingText(e.clientX, e.clientY, `-${GameConfig.scoreMiss}`);
        };

        function showFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.classList.add('floating-penalty');
            el.style.left = (x - 20) + 'px';
            el.style.top = (y - 20) + 'px';
            el.innerText = text;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function loseLife() {
            gameState.lives--;
            updateLivesUI();
            playSound('miss'); // Son d'erreur aussi quand on perd une vie

            if (gameState.lives <= 0) {
                gameOver();
            }
        }

        async function gameOver() {
            gameState.active = false;
            clearTimeout(gameState.spawnTimeout);
            clearInterval(gameState.difficultyTimer);

            const overlay = document.getElementById('game-overlay');
            const title = document.getElementById('overlay-title');
            const finalScore = document.getElementById('final-score-display');

            title.textContent = "SYSTEM FAILURE";
            title.style.color = "var(--danger)";
            finalScore.style.display = "block";
            finalScore.querySelector('span').textContent = gameState.score;

            overlay.classList.remove('hidden-overlay');

            await saveScore(gameState.score);
            loadLeaderboard();
        }

        // --- UI UPDATES ---

        function updateScoreUI() {
            document.getElementById('current-score').textContent = gameState.score;
        }

        function updateSpeedUI() {
            // Calcul pourcentage vitesse (inversement proportionnel au délai)
            const speedPct = Math.round((GameConfig.startSpawnRate / gameState.currentRate) * 100);
            document.getElementById('speed-display').textContent = `VITESSE: ${speedPct}%`;
        }

        function updateLivesUI() {
            const container = document.getElementById('lives-container');
            container.innerHTML = '';
            for(let i=0; i<3; i++) {
                const pip = document.createElement('div');
                pip.className = 'life-pip ' + (i >= gameState.lives ? 'life-lost' : '');
                container.appendChild(pip);
            }
        }

        // --- API CALLS ---

        async function loadLeaderboard() {
            const container = document.getElementById('leaderboard-list');
            const token = localStorage.getItem('sas_token');

            try {
                const res = await fetch('/api/arcade', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const scores = await res.json();
                    container.innerHTML = scores.map((s, i) => {
                        let rankClass = i === 0 ? 'rank-1' : (i === 1 ? 'rank-2' : (i === 2 ? 'rank-3' : ''));
                        return `
                            <div class="rank-row ${rankClass}">
                                <span>#${s.rank} ${s.username.toUpperCase()}</span>
                                <span>${s.score} PTS</span>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function saveScore(score) {
            if (score === 0) return;
            const token = localStorage.getItem('sas_token');
            try {
                await fetch('/api/arcade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ score: score })
                });
            } catch (e) { console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', loadLeaderboard);

    </script>
</body>
</html>