<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - TACTICAL TRAINING</title>

    <script>
        if (!localStorage.getItem('sas_session')) window.location.href = 'index.html';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style-mo.css">

    <style>
        /* --- CSS SPÉCIFIQUE ARCADE --- */

        .arcade-container {
            display: grid;
            grid-template-columns: 3fr 1fr; /* Jeu large / Leaderboard étroit */
            gap: 20px;
            height: calc(100vh - 160px);
        }

        /* ZONE DE JEU */
        .game-viewport {
            background: rgba(5, 8, 10, 0.8);
            border: 2px solid var(--dim);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        .game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
            transition: opacity 0.3s;
        }
        .hidden-overlay { opacity: 0; pointer-events: none; }

        .game-title { font-size: 3rem; color: var(--primary); text-shadow: 0 0 20px var(--primary); margin-bottom: 20px; font-weight: 800; letter-spacing: 5px; }
        .game-score-display { position: absolute; top: 20px; right: 30px; font-size: 2rem; color: #fff; font-family: 'Share Tech Mono'; pointer-events: none; }
        .lives-display { position: absolute; top: 20px; left: 30px; display: flex; gap: 10px; pointer-events: none; }
        .life-pip { width: 15px; height: 15px; background: var(--danger); box-shadow: 0 0 10px var(--danger); transform: rotate(45deg); }

        /* NŒUDS DU JEU (CIBLES) */
        .node-target {
            position: absolute;
            width: 50px; height: 50px;
            border: 2px solid var(--primary);
            background: rgba(0, 255, 157, 0.1);
            cursor: crosshair;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: var(--primary);
            animation: spawnPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 15px var(--primary);
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        }
        .node-target::before { content: ''; position: absolute; width: 100%; height: 100%; border: 1px solid rgba(255,255,255,0.2); animation: spin 4s linear infinite; }
        .node-target:active { transform: scale(0.9); background: var(--primary); color: #000; }

        @keyframes spawnPop { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* LEADERBOARD */
        .leaderboard-panel {
            background: rgba(15, 20, 25, 0.6);
            border: 1px solid var(--primary);
            display: flex; flex-direction: column;
        }
        .rank-row {
            display: flex; justify-content: space-between; padding: 12px;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            font-family: 'Share Tech Mono';
        }
        .rank-1 { color: #d4af37; text-shadow: 0 0 10px #d4af37; font-weight: bold; font-size: 1.1rem; background: rgba(212, 175, 55, 0.05); }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; }

        .btn-game {
            background: transparent; border: 2px solid var(--primary); color: var(--primary);
            padding: 15px 40px; font-size: 1.2rem; cursor: pointer; font-family: 'Share Tech Mono';
            text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .btn-game:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }

        /* Effet "Scanline" sur le jeu */
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(0, 255, 157, 0.3); opacity: 0.5; pointer-events: none;
            animation: scanDown 3s linear infinite; z-index: 5;
        }
        @keyframes scanDown { 0% {top:0;} 100% {top:100%;} }

    </style>
</head>
<body>

    <div class="crt-overlay"></div>

    <div class="terminal-wrapper">
        <main class="terminal">

            <header class="header-strip">
                <div>
                    <h1>TRAINING :: <span style="color: var(--primary);">SIMULATION</span></h1>
                    <div style="color: var(--dim); font-size: 0.9rem; letter-spacing: 3px;">SHADOW COMPANY // REFLEX TEST</div>
                </div>
                <div class="meta-data">
                    <div>MODULE: SYSTEM_BREACH_V1</div>
                    <a href="index.html" style="color: var(--secondary); text-decoration: none;">[ RETOUR ]</a>
                </div>
            </header>

            <div class="arcade-container">

                <div class="game-viewport" id="game-area">
                    <div class="scan-line"></div>

                    <div class="game-score-display">SCORE: <span id="current-score">0</span></div>
                    <div class="lives-display" id="lives-container">
                        <div class="life-pip"></div>
                        <div class="life-pip"></div>
                        <div class="life-pip"></div>
                    </div>

                    <div id="game-overlay" class="game-overlay">
                        <div class="game-title" id="overlay-title">SYSTEM BREACH</div>
                        <div style="margin-bottom: 30px; text-align: center; color: #aaa; font-family: 'JetBrains Mono'; font-size: 0.9rem;">
                            NEUTRALISEZ LES NŒUDS DE SÉCURITÉ.<br>
                            VITESSE PROGRESSIVE. 3 ERREURS MAX.
                        </div>
                        <div id="final-score-display" style="font-size: 1.5rem; color: #fff; margin-bottom: 20px; display: none;">
                            SCORE FINAL: <span style="color:var(--primary)">0</span>
                        </div>
                        <button class="btn-game" onclick="startGame()">LANCER SIMULATION</button>
                    </div>

                </div>

                <div class="leaderboard-panel panel">
                    <div class="panel-header">
                        <span class="panel-title" style="color:var(--warning)">TOP OPERATORS</span>
                        <span style="font-size:0.7rem;">GLOBAL_RANK</span>
                    </div>

                    <div id="leaderboard-list" style="flex: 1; overflow-y: auto;">
                        <div style="padding: 20px; text-align: center; color: #666;" class="blink">CONNEXION SERVEUR...</div>
                    </div>

                    <div style="padding: 10px; border-top: 1px solid var(--dim); font-size: 0.7rem; color: #555; text-align: center;">
                        CLASSIFIED RECORDS
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script>
        // CONFIGURATION DU JEU
        const GameConfig = {
            startSpawnRate: 1500, // ms
            minSpawnRate: 400,    // ms max speed
            despawnTimeBase: 2000, // temps avant disparition
            speedUpStep: 50,      // réduction ms par palier
            scoreStep: 100        // points par cible
        };

        let gameState = {
            active: false,
            score: 0,
            lives: 3,
            spawnInterval: null,
            currentRate: GameConfig.startSpawnRate,
            activeNodes: []
        };

        // --- AUDIO SYNTHÉTIQUE (Pas de chargement externe) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'hit') {
                // Son aigu futuriste (Succès)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'miss') {
                // Son grave buzz (Erreur)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'start') {
                // Son de démarrage
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            }
        }

        // --- LOGIQUE DU JEU ---

        function startGame() {
            playSound('start');
            // Reset state
            gameState.active = true;
            gameState.score = 0;
            gameState.lives = 3;
            gameState.currentRate = GameConfig.startSpawnRate;
            gameState.activeNodes = [];

            // UI Reset
            document.getElementById('game-overlay').classList.add('hidden-overlay');
            document.getElementById('current-score').textContent = "0";
            updateLivesUI();

            // Nettoyage zone
            document.querySelectorAll('.node-target').forEach(n => n.remove());

            // Lancer la boucle
            gameLoop();
        }

        function gameLoop() {
            if (!gameState.active) return;

            spawnNode();

            // Calcul de la prochaine apparition (accélération)
            let nextSpawn = gameState.currentRate;
            // Tous les 500 points, on accélère
            if (gameState.score > 0 && gameState.score % 500 === 0) {
                if (gameState.currentRate > GameConfig.minSpawnRate) {
                    gameState.currentRate -= GameConfig.speedUpStep;
                }
            }

            gameState.spawnInterval = setTimeout(gameLoop, nextSpawn);
        }

        function spawnNode() {
            const gameArea = document.getElementById('game-area');
            const node = document.createElement('div');
            node.classList.add('node-target');

            // Position aléatoire (en tenant compte de la taille du node 50px)
            const maxX = gameArea.clientWidth - 60;
            const maxY = gameArea.clientHeight - 60;
            const x = Math.floor(Math.random() * maxX);
            const y = Math.floor(Math.random() * maxY);

            node.style.left = x + 'px';
            node.style.top = y + 'px';

            // Code hexadécimal aléatoire pour le style
            node.innerText = '0x' + Math.floor(Math.random()*255).toString(16).toUpperCase();

            // Gestion du clic
            node.onmousedown = () => {
                if (!gameState.active) return;
                playSound('hit');
                gameState.score += GameConfig.scoreStep;
                document.getElementById('current-score').textContent = gameState.score;

                // Effet visuel
                node.style.background = '#fff';
                node.style.transform = 'scale(1.5)';
                node.style.opacity = '0';
                setTimeout(() => node.remove(), 200);

                // Retirer du tableau des actifs pour ne pas trigger le timeout
                clearTimeout(node.despawnTimer);
            };

            gameArea.appendChild(node);

            // Timer de disparition (Miss)
            // Plus le score est haut, plus le temps de disparition est court
            const difficultyMod = Math.min(1000, gameState.score / 2);
            const lifeTime = Math.max(800, GameConfig.despawnTimeBase - difficultyMod);

            node.despawnTimer = setTimeout(() => {
                if (node.parentNode) {
                    node.remove();
                    playSound('miss');
                    loseLife();
                }
            }, lifeTime);
        }

        function loseLife() {
            gameState.lives--;
            updateLivesUI();

            const gameArea = document.getElementById('game-area');
            gameArea.style.boxShadow = "inset 0 0 50px var(--danger)";
            setTimeout(() => gameArea.style.boxShadow = "inset 0 0 50px rgba(0,0,0,0.8)", 200);

            if (gameState.lives <= 0) {
                gameOver();
            }
        }

        function updateLivesUI() {
            const container = document.getElementById('lives-container');
            container.innerHTML = '';
            for(let i=0; i<gameState.lives; i++) {
                container.innerHTML += `<div class="life-pip"></div>`;
            }
        }

        async function gameOver() {
            gameState.active = false;
            clearTimeout(gameState.spawnInterval);

            // UI
            const overlay = document.getElementById('game-overlay');
            const title = document.getElementById('overlay-title');
            const finalScore = document.getElementById('final-score-display');

            title.textContent = "SYSTEM FAILURE";
            title.style.color = "var(--danger)";
            finalScore.style.display = "block";
            finalScore.querySelector('span').textContent = gameState.score;

            overlay.classList.remove('hidden-overlay');

            // Envoi Score
            await saveScore(gameState.score);
            loadLeaderboard();
        }

        // --- API & DATA ---

        async function loadLeaderboard() {
            const container = document.getElementById('leaderboard-list');
            const token = localStorage.getItem('sas_token');

            try {
                const res = await fetch('/api/arcade', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const scores = await res.json();
                    container.innerHTML = scores.map((s, i) => {
                        let rankClass = '';
                        if(i===0) rankClass = 'rank-1';
                        if(i===1) rankClass = 'rank-2';
                        if(i===2) rankClass = 'rank-3';

                        return `
                            <div class="rank-row ${rankClass}">
                                <span>#${s.rank} ${s.username.toUpperCase()}</span>
                                <span>${s.score} PTS</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="padding:20px; color:var(--danger)">OFFLINE</div>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function saveScore(score) {
            if (score === 0) return;
            const token = localStorage.getItem('sas_token');
            try {
                await fetch('/api/arcade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ score: score })
                });
            } catch (e) {
                console.error("Save score error", e);
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', loadLeaderboard);

    </script>
</body>
</html>