<div class="panel">
    <div class="panel-header">
        <span class="panel-title">STATUS PHYSIQUE</span>
        <span style="color:var(--danger); font-size:0.7rem;" class="blink" id="med-alert-status">SCANNING...</span>
    </div>

    <div style="display: flex; gap: 20px; align-items: center; justify-content: center;">
        <div style="position: relative; height: 250px; width: 150px;">
            <svg viewBox="0 0 100 200" style="height: 100%; width: 100%; filter: drop-shadow(0 0 5px var(--primary));">
                <style>
                    .body-part { fill: rgba(0, 255, 157, 0.1); stroke: var(--primary); stroke-width: 1; cursor: pointer; transition: 0.3s; }
                    .body-part:hover { fill: rgba(0, 255, 157, 0.3); }
                    .body-part.injured { fill: rgba(255, 51, 51, 0.6); stroke: var(--danger); animation: pulseInjure 2s infinite; }
                    @keyframes pulseInjure { 0% {opacity: 0.6;} 50% {opacity: 1;} 100% {opacity: 0.6;} }
                </style>

                <circle id="part-head" class="body-part" cx="50" cy="20" r="12" onclick="openInjuryModal('head')"/>
                <path id="part-torso" class="body-part" d="M35 35 L65 35 L60 90 L40 90 Z" onclick="openInjuryModal('torso')"/>
                <rect id="part-left_arm" class="body-part" x="15" y="38" width="15" height="60" rx="5" onclick="openInjuryModal('left_arm')"/>
                <rect id="part-right_arm" class="body-part" x="70" y="38" width="15" height="60" rx="5" onclick="openInjuryModal('right_arm')"/>
                <rect id="part-left_leg" class="body-part" x="30" y="95" width="18" height="80" rx="5" onclick="openInjuryModal('left_leg')"/>
                <rect id="part-right_leg" class="body-part" x="52" y="95" width="18" height="80" rx="5" onclick="openInjuryModal('right_leg')"/>
            </svg>
        </div>

        <div id="injury-list-display" style="flex: 1; font-size: 0.8rem; max-height: 200px; overflow-y: auto; font-family: 'JetBrains Mono';">
            <div style="color:#555; font-style:italic;">Aucune blessure détectée.</div>
        </div>
    </div>
</div>

<div id="injury-modal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 400px; border-color: var(--danger);">
        <div class="modal-top" style="background: rgba(255,51,51,0.1);">
            <span class="modal-title" style="color: var(--danger);">SIGNALEMENT BLESSURE</span>
            <button onclick="closeInjuryModal()" style="background:none; border:none; color:#666; cursor:pointer;">✖</button>
        </div>
        <form id="injury-form" style="padding: 20px;">
            <input type="hidden" id="inj-part">
            <div class="form-group">
                <label>ZONE CORPORELLE</label>
                <input type="text" id="inj-part-display" class="form-input" disabled style="color:var(--primary); font-weight:bold;">
            </div>
            <div class="form-group">
                <label>GRAVITÉ</label>
                <select id="inj-severity" class="form-input">
                    <option value="light">LÉGÈRE (Egratignure, Bleu)</option>
                    <option value="moderate">MODÉRÉE (Entorse, Coupure)</option>
                    <option value="critical">CRITIQUE (Balle, Fracture)</option>
                </select>
            </div>
            <div class="form-group">
                <label>DESCRIPTION</label>
                <textarea id="inj-desc" class="form-textarea" style="height:80px;" placeholder="Ex: Impact de balle 9mm..."></textarea>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button type="button" onclick="closeInjuryModal()" class="btn-cancel">ANNULER</button>
                <button type="submit" class="btn-confirm" style="background:var(--danger); color:#fff;">SIGNALER</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadMyInjuries);

    function openInjuryModal(part) {
        const partNames = {
            'head': 'TÊTE / CRÂNE',
            'torso': 'TORSE / ORGANES',
            'left_arm': 'BRAS GAUCHE',
            'right_arm': 'BRAS DROIT',
            'left_leg': 'JAMBE GAUCHE',
            'right_leg': 'JAMBE DROITE'
        };
        document.getElementById('inj-part').value = part;
        document.getElementById('inj-part-display').value = partNames[part];
        document.getElementById('injury-modal').classList.remove('hidden');
    }

    function closeInjuryModal() {
        document.getElementById('injury-modal').classList.add('hidden');
        document.getElementById('injury-form').reset();
    }

    document.getElementById('injury-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const session = JSON.parse(localStorage.getItem('sas_session'));

        const payload = {
            agent_id: session.id,
            body_part: document.getElementById('inj-part').value,
            severity: document.getElementById('inj-severity').value,
            description: document.getElementById('inj-desc').value
        };

        try {
            const res = await fetch('/api/medical', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('sas_token')}`
                },
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                closeInjuryModal();
                loadMyInjuries();
            } else {
                alert("Erreur lors du signalement.");
            }
        } catch(e) { console.error(e); }
    });

    async function loadMyInjuries() {
        const session = JSON.parse(localStorage.getItem('sas_session'));
        const svgParts = document.querySelectorAll('.body-part');
        svgParts.forEach(p => p.classList.remove('injured'));

        try {
            const res = await fetch(`/api/medical?agent_id=${session.id}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('sas_token')}` }
            });
            const injuries = await res.json();

            const listContainer = document.getElementById('injury-list-display');
            const alertStatus = document.getElementById('med-alert-status');

            if (injuries.length === 0) {
                listContainer.innerHTML = '<div style="color:#555; font-style:italic;">> SYSTÈMES VITAUX NOMINAUX.</div>';
                alertStatus.textContent = "OK";
                alertStatus.style.color = "var(--primary)";
                return;
            }

            alertStatus.textContent = "ATTENTION REQUISE";
            alertStatus.style.color = "var(--danger)";
            listContainer.innerHTML = '';

            injuries.forEach(inj => {
                const partEl = document.getElementById(`part-${inj.body_part}`);
                if(partEl) partEl.classList.add('injured');

                let severityColor = inj.severity === 'critical' ? '#ff3333' : (inj.severity === 'moderate' ? '#eebb00' : '#ccc');

                listContainer.innerHTML += `
                <div style="border-left: 2px solid ${severityColor}; padding-left: 8px; margin-bottom: 8px;">
                    <div style="color:${severityColor}; font-weight:bold;">${inj.body_part.toUpperCase().replace('_', ' ')}</div>
                    <div style="color:#aaa;">${inj.description}</div>
                </div>
            `;
            });

        } catch(e) { console.error("Erreur chargement médical", e); }
    }
</script>