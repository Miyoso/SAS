<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - User Profile [CLASSIFIED]</title>

    <script>
        const session = localStorage.getItem('sas_session');
        if (!session) {
            window.location.href = 'index.html';
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Share+Tech+Mono&family=Libre+Barcode+128+Text&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style-mo.css">

    <style>
        body {
            justify-content: flex-start;
            padding-top: 50px;
        }

        .terminal-wrapper {
            opacity: 0;
            animation: slideIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 10px 20px;
            font-family: 'Share Tech Mono';
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-logout:hover {
            background: rgba(255, 51, 51, 0.1);
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.3);
            text-shadow: 0 0 5px var(--danger);
        }

        .btn-security {
            background: transparent;
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 10px 20px;
            font-family: 'Share Tech Mono';
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.3s;
            margin-right: 10px;
        }
        .btn-security:hover {
            background: rgba(238, 187, 0, 0.1);
            box-shadow: 0 0 15px rgba(238, 187, 0, 0.3);
            text-shadow: 0 0 5px var(--warning);
        }

        .default-avatar {
            width: 100%; height: 100%;
            background: #111;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: #333;
        }

        #my-equipment-list::-webkit-scrollbar, #my-missions-list::-webkit-scrollbar {
            width: 5px;
        }
        #my-equipment-list::-webkit-scrollbar-track, #my-missions-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
        }
        #my-equipment-list::-webkit-scrollbar-thumb, #my-missions-list::-webkit-scrollbar-thumb {
            background: var(--primary);
        }

        /* Styles Modale S√©curit√© (Inspir√©s de Missions.html) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 10000; display: flex; justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }
        .modal-box {
            background: #0b0e11; border: 1px solid var(--warning);
            box-shadow: 0 0 50px rgba(238, 187, 0, 0.1);
            width: 400px; padding: 0;
        }
        .modal-top {
            padding: 15px 25px; border-bottom: 1px solid #333; background: rgba(0,0,0,0.3);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-family: 'Share Tech Mono'; color: var(--warning); letter-spacing: 2px; }
        .form-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid #444;
            color: #fff; padding: 10px; margin-top: 5px; font-family: 'JetBrains Mono';
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { color: #888; font-size: 0.7rem; letter-spacing: 1px; }

        .btn-confirm {
            background: var(--warning); color: #000; border: none; padding: 10px 20px;
            font-family: 'Share Tech Mono'; font-weight: bold; cursor: pointer;
        }
        .btn-cancel {
            background: transparent; border: 1px solid #666; color: #888; padding: 10px 20px;
            font-family: 'Share Tech Mono'; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="terminal-wrapper">
    <main class="terminal">

        <header class="header-strip">
            <div>
                <h1>DOSSIER :: <span id="header-username">UNKNOWN</span></h1>
                <div style="color: var(--primary); font-size: 0.9rem; letter-spacing: 3px;">SHADOW COMPANY // PERSONNEL</div>
            </div>
            <div class="meta-data">
                <div>STATUS: <span style="color: var(--primary)">ONLINE</span></div>
                <div>SESSION ID: <span class="blink" id="session-id">...</span></div>
            </div>
        </header>

        <section class="hero-section">
            <div class="id-card-container">
                <div class="id-card" id="card">
                    <div class="holo-overlay"></div>

                    <div class="card-header">
                        <div class="card-logo-text">SHADOW CO.</div>
                        <div class="security-level" id="card-rank-badge" style="background: var(--primary); color: #000;">OPERATOR</div>
                    </div>

                    <div class="card-body">
                        <div class="photo-box" style="border-color: var(--secondary); overflow:hidden;">
                            <div class="default-avatar" id="user-avatar-container">üë§</div>
                        </div>
                        <div class="agent-info">
                            <div class="card-label">NOM DE CODE</div>
                            <div class="card-value" id="card-username">...</div>

                            <div class="card-label">UNIT√â</div>
                            <div class="card-value" style="color: var(--secondary);">FIELD OPS</div>

                            <div class="card-label">ACCR√âDITATION</div>
                            <div class="card-code" id="card-rank-code">LVL-?-UNDEF</div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="barcode" style="font-family: 'Libre Barcode 128 Text', cursive;">1100101010</div>
                        <div class="chip"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="intel-grid">

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">BIO_METRICS</span>
                    <span style="color:var(--danger); font-size:0.7rem;" class="blink">LIVE_FEED</span>
                </div>

                <div class="biometric-row">
                    <div class="ecg-wrapper">
                        <canvas id="ecg-canvas"></canvas>
                        <div class="ecg-overlay"></div>
                    </div>
                    <div class="bpm-readout">
                        <span class="label">HR_BPM</span>
                        <span id="bpm-value" style="font-size: 1.5rem; color: var(--primary); font-weight: bold;">--</span>
                    </div>
                </div>

                <div class="separator-dashed"></div>

                <div class="psy-section">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span class="label">CORTISOL_LEVEL (STRESS)</span>
                        <span id="stress-pct" style="color: var(--secondary)">0%</span>
                    </div>

                    <div class="progress-track">
                        <div id="stress-bar" class="progress-fill-psy"></div>
                    </div>

                    <div class="psy-status-text" id="psy-status-text">
                        NEURO-STABLE
                    </div>

                    <div class="psy-controls">
                        <button onclick="adjustStress(-10)" class="btn-psy">[- CALM]</button>
                        <button onclick="adjustStress(10)" class="btn-psy">[+ STRESS]</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">DOTATION</span>
                    <span style="color:var(--secondary); font-size:0.7rem;">GEAR_ASSIGNED</span>
                </div>
                <div id="my-equipment-list" style="max-height: 200px; overflow-y: auto; padding-right: 5px;">
                    <div class="blink" style="color: #555;">CHARGEMENT INVENTAIRE...</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title" style="color: var(--warning)">MISSIONS ASSIGN√âES</span>
                    <span style="color:var(--warning); font-size:0.7rem;">ORDERS</span>
                </div>
                <div id="my-missions-list" style="max-height: 200px; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 8px;">
                    <div class="blink" style="color: #555;">R√âCUP√âRATION DES ORDRES...</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">SYST√àME</span>
                    <span style="color:var(--secondary); font-size:0.7rem;">ACCESS_LOG</span>
                </div>

                <div class="log-entry">
                         <span style="color: var(--primary)">[+]
                             <span>CONNEXION S√âCURIS√âE √âTABLIE</span>
                         </span>
                </div>

                <div class="log-entry">
                         <span style="color: var(--primary)">[+]
                             <span>AUTHENTIFICATION BIOM√âTRIQUE : OK</span>
                         </span>
                </div>

                <div style="margin-top: 25px; border-top: 1px dashed #444; padding-top: 15px; display:flex; justify-content:center;">
                    <button onclick="openPasswordModal()" class="btn-security">[ S√âCURIT√â ]</button>
                    <button onclick="logout()" class="btn-logout">[ TERMINATE SESSION ]</button>
                </div>
            </div>

        </section>

        <footer class="footer">
            <div>SECURE TERMINAL V.4.0.2</div>
            <div>
                <a href="database.html" style="color: var(--secondary); text-decoration: none;">[ ACC√âDER √Ä LA BASE DE DONN√âES ]</a>
            </div>
        </footer>

    </main>
</div>

<div id="password-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-top">
            <span class="modal-title">CHANGEMENT MOT DE PASSE</span>
            <button onclick="closePasswordModal()" style="background:none; border:none; color:#666; cursor:pointer;">‚úñ</button>
        </div>

        <form id="password-form" style="padding: 25px;">
            <div class="form-group">
                <label>ANCIEN MOT DE PASSE</label>
                <input type="password" id="pwd-old" class="form-input" required>
            </div>
            <div class="form-group">
                <label>NOUVEAU MOT DE PASSE</label>
                <input type="password" id="pwd-new" class="form-input" required>
            </div>
            <div class="form-group">
                <label>CONFIRMATION</label>
                <input type="password" id="pwd-confirm" class="form-input" required>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button type="button" onclick="closePasswordModal()" class="btn-cancel">ANNULER</button>
                <button type="submit" class="btn-confirm">VALIDER</button>
            </div>
        </form>
    </div>
</div>

<script src="js/profile-equipment.js"></script>
<script>
    // Liste des avatars disponibles dans le dossier /assets/
    const avatarMap = {
        'adam': 'Adam.jpg',
        'blake': 'Blake.png',
        'blitz': 'Blitz.png',
        'dust': 'Dust.png',
        'wei': 'Dust.png', // Alias
        'graves': 'Graves.jpg',
        'jackal': 'Jackal.jpg',
        'ji': 'Jackal.jpg', // Alias
        'javier': 'Javier.jpg',
        'lexa': 'Lexa.png',
        'selena': 'Lexa.png', // Alias
        'lovelace': 'LoveLace.jpg',
        'nyx': 'LoveLace.jpg', // Alias
        'roxanne': 'Roxanne.jpg'
    };

    document.addEventListener('DOMContentLoaded', () => {
        const sessionData = JSON.parse(localStorage.getItem('sas_session'));

        if (sessionData) {
            const { username, rank } = sessionData;

            document.getElementById('header-username').textContent = username.toUpperCase();
            document.getElementById('card-username').textContent = username.toUpperCase();

            const rankDisplay = `LVL-${rank}`;
            document.getElementById('card-rank-code').textContent = rankDisplay;
            document.getElementById('card-rank-badge').textContent = rank >= 5 ? 'COMMAND' : (rank >= 3 ? 'OFFICER' : 'OPERATOR');

            document.getElementById('session-id').textContent = '0x' + Math.floor(Math.random()*16777215).toString(16).toUpperCase();

            // --- INJECTION DE LA PHOTO ---
            const lowerName = username.toLowerCase();
            if (avatarMap[lowerName]) {
                const photoContainer = document.querySelector('.photo-box');
                photoContainer.innerHTML = `<img src="assets/${avatarMap[lowerName]}" alt="${username}" style="width:100%; height:100%; object-fit:cover; filter: grayscale(1) contrast(1.2);">`;
            }

            loadMyMissions(username);
        }

        // Animation Carte 3D
        const card = document.getElementById('card');
        const cardContainer = document.querySelector('.id-card-container');
        cardContainer.addEventListener('mousemove', (e) => {
            const rect = cardContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const rotateX = ((y - centerY) / centerY) * -10;
            const rotateY = ((x - centerX) / centerX) * 10;
            card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
        });
        cardContainer.addEventListener('mouseleave', () => {
            card.style.transform = `rotateX(0deg) rotateY(0deg) scale(1)`;
        });

        initPsychometrics();
        initECG();
    });

    // --- GESTION MISSIONS ---
    async function loadMyMissions(username) {
        const container = document.getElementById('my-missions-list');
        try {
            const res = await fetch(`/api/game?entity=missions&agent=${username}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('sas_token')}` }
            });
            const missions = await res.json();

            if(missions.length === 0) {
                container.innerHTML = '<div style="color:rgba(255,255,255,0.4); font-style:italic; font-size:0.8rem; padding:10px;">> AUCUN ORDRE EN ATTENTE</div>';
                return;
            }

            container.innerHTML = missions.map(m => {
                let borderCol = 'var(--warning)';
                let statusText = 'PLANIFI√âE';

                if(m.status === 'ACTIVE') { borderCol = 'var(--danger)'; statusText = 'EN COURS'; }
                if(m.status === 'COMPLETED') { borderCol = 'var(--primary)'; statusText = 'TERMIN√âE'; }

                const date = new Date(m.start_time).toLocaleDateString('fr-FR');

                return `
                        <div style="background: rgba(255,255,255,0.03); border-left: 3px solid ${borderCol}; padding: 10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="font-weight:bold; color:#fff; font-family:'Share Tech Mono';">${m.title}</span>
                                <span style="font-size:0.65rem; color:${borderCol}; border:1px solid ${borderCol}; padding:1px 4px; border-radius:3px;">${statusText}</span>
                            </div>
                            <div style="font-size:0.75rem; color:#888; font-family:'JetBrains Mono'; display:flex; justify-content:space-between;">
                                <span>üìç ${m.location}</span>
                                <span>üìÖ ${date}</span>
                            </div>
                        </div>
                    `;
            }).join('');

        } catch(e) { console.error(e); }
    }

    // --- GESTION MOT DE PASSE ---
    function openPasswordModal() {
        document.getElementById('password-modal').classList.remove('hidden');
    }
    function closePasswordModal() {
        document.getElementById('password-modal').classList.add('hidden');
        document.getElementById('password-form').reset();
    }

    document.getElementById('password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const oldPwd = document.getElementById('pwd-old').value;
        const newPwd = document.getElementById('pwd-new').value;
        const confirmPwd = document.getElementById('pwd-confirm').value;

        if (newPwd !== confirmPwd) {
            alert("‚ùå LES MOTS DE PASSE NE CORRESPONDENT PAS");
            return;
        }

        try {
            const res = await fetch('/api/auth?action=change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('sas_token')}`
                },
                body: JSON.stringify({ oldPassword: oldPwd, newPassword: newPwd })
            });

            const data = await res.json();

            if (res.ok) {
                alert("‚úÖ MOT DE PASSE MIS √Ä JOUR AVEC SUCC√àS");
                closePasswordModal();
            } else {
                alert("‚ùå ERREUR: " + data.error);
            }
        } catch (err) {
            alert("‚ùå ERREUR DE CONNEXION");
        }
    });

    // --- BIO & SYSTEM ---
    function initPsychometrics() {
        let currentStress = parseInt(localStorage.getItem('sas_stress_level')) || 0;
        updateStressUI(currentStress);
    }
    function adjustStress(amount) {
        let currentStress = parseInt(localStorage.getItem('sas_stress_level')) || 0;
        currentStress += amount;
        if (currentStress < 0) currentStress = 0;
        if (currentStress > 100) currentStress = 100;
        localStorage.setItem('sas_stress_level', currentStress);
        updateStressUI(currentStress);
    }
    function updateStressUI(level) {
        const bar = document.getElementById('stress-bar');
        const pct = document.getElementById('stress-pct');
        const txt = document.getElementById('psy-status-text');
        bar.style.width = level + '%';
        pct.textContent = level + '%';
        if (level < 30) { bar.style.backgroundColor = '#00ff9d'; txt.textContent = "NEURO-STABLE"; txt.style.color = '#00ff9d'; targetBPM = 60 + (level / 2); }
        else if (level < 70) { bar.style.backgroundColor = '#eebb00'; txt.textContent = "STRESS √âLEV√â"; txt.style.color = '#eebb00'; targetBPM = 90 + ((level - 30)); }
        else { bar.style.backgroundColor = '#ff3333'; txt.textContent = "CRITIQUE"; txt.style.color = '#ff3333'; targetBPM = 130 + ((level - 70) * 1.5); }
    }

    let ctx, canvas, xPos = 0, targetBPM = 65, lastFrameTime = 0;
    function initECG() {
        canvas = document.getElementById('ecg-canvas');
        if(!canvas) return;
        ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        requestAnimationFrame(drawECG);
        setInterval(() => {
            const noise = Math.floor(Math.random() * 6) - 3;
            document.getElementById('bpm-value').textContent = Math.floor(targetBPM + noise);
        }, 2000);
    }
    function drawECG(timestamp) {
        if (!lastFrameTime) lastFrameTime = timestamp;
        const delta = timestamp - lastFrameTime;
        const speed = (canvas.width * (targetBPM / 60)) / 100;
        ctx.strokeStyle = targetBPM > 100 ? (targetBPM > 140 ? '#ff3333' : '#eebb00') : '#00ff9d';
        ctx.lineWidth = 2; ctx.shadowBlur = 5; ctx.shadowColor = ctx.strokeStyle;
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath(); ctx.moveTo(xPos, canvas.height / 2);
        xPos += speed;
        let y = canvas.height / 2;
        const phase = xPos % 100;
        if (phase > 10 && phase < 15) y -= 5; else if (phase > 20 && phase < 25) y += 5; else if (phase > 25 && phase < 35) y -= 25; else if (phase > 35 && phase < 40) y += 10; else if (phase > 50 && phase < 60) y -= 8;
        y += (Math.random() * 2 - 1);
        ctx.lineTo(xPos, y); ctx.stroke();
        if (xPos >= canvas.width) { xPos = 0; ctx.clearRect(0,0, canvas.width, canvas.height); ctx.beginPath(); }
        lastFrameTime = timestamp; requestAnimationFrame(drawECG);
    }

    function logout() {
        document.body.style.transition = "opacity 0.5s"; document.body.style.opacity = "0";
        setTimeout(() => { localStorage.removeItem('sas_session'); localStorage.removeItem('userSecurityLevel'); localStorage.removeItem('sas_token'); window.location.href = 'index.html'; }, 500);
    }
</script>
</body>
</html>