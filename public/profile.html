<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - User Profile [CLASSIFIED]</title>

    <script>
        const session = localStorage.getItem('sas_session');
        if (!session) {
            window.location.href = 'index.html';
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Share+Tech+Mono&family=Libre+Barcode+128+Text&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style-mo.css">

    <style>
        body {
            justify-content: flex-start;
            padding-top: 50px;
        }
        
        .terminal-wrapper {
            opacity: 0;
            animation: slideIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 10px 20px;
            font-family: 'Share Tech Mono';
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-logout:hover {
            background: rgba(255, 51, 51, 0.1);
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.3);
            text-shadow: 0 0 5px var(--danger);
        }

        .default-avatar {
            width: 100%; height: 100%;
            background: #111;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: #333;
        }

        #my-equipment-list::-webkit-scrollbar, #my-missions-list::-webkit-scrollbar {
            width: 5px;
        }
        #my-equipment-list::-webkit-scrollbar-track, #my-missions-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
        }
        #my-equipment-list::-webkit-scrollbar-thumb, #my-missions-list::-webkit-scrollbar-thumb {
            background: var(--primary);
        }
    </style>
</head>
<body>

    <div class="terminal-wrapper">
        <main class="terminal">

            <header class="header-strip">
                <div>
                    <h1>DOSSIER :: <span id="header-username">UNKNOWN</span></h1>
                    <div style="color: var(--primary); font-size: 0.9rem; letter-spacing: 3px;">SHADOW COMPANY // PERSONNEL</div>
                </div>
                <div class="meta-data">
                    <div>STATUS: <span style="color: var(--primary)">ONLINE</span></div>
                    <div>SESSION ID: <span class="blink" id="session-id">...</span></div>
                </div>
            </header>

            <section class="hero-section">
                <div class="id-card-container">
                    <div class="id-card" id="card">
                        <div class="holo-overlay"></div>

                        <div class="card-header">
                            <div class="card-logo-text">SHADOW CO.</div>
                            <div class="security-level" id="card-rank-badge" style="background: var(--primary); color: #000;">OPERATOR</div>
                        </div>

                        <div class="card-body">
                            <div class="photo-box" style="border-color: var(--secondary);">
                                <div class="default-avatar">üë§</div>
                            </div>
                            <div class="agent-info">
                                <div class="card-label">NOM DE CODE</div>
                                <div class="card-value" id="card-username">...</div>

                                <div class="card-label">UNIT√â</div>
                                <div class="card-value" style="color: var(--secondary);">FIELD OPS</div>

                                <div class="card-label">ACCR√âDITATION</div>
                                <div class="card-code" id="card-rank-code">LVL-?-UNDEF</div>
                            </div>
                        </div>

                        <div class="card-footer">
                            <div class="barcode" style="font-family: 'Libre Barcode 128 Text', cursive;">1100101010</div>
                            <div class="chip"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="intel-grid">

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">BIO_METRICS</span>
                        <span style="color:var(--danger); font-size:0.7rem;" class="blink">LIVE_FEED</span>
                    </div>

                    <div class="biometric-row">
                        <div class="ecg-wrapper">
                            <canvas id="ecg-canvas"></canvas>
                            <div class="ecg-overlay"></div>
                        </div>
                        <div class="bpm-readout">
                            <span class="label">HR_BPM</span>
                            <span id="bpm-value" style="font-size: 1.5rem; color: var(--primary); font-weight: bold;">--</span>
                        </div>
                    </div>

                    <div class="separator-dashed"></div>

                    <div class="psy-section">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span class="label">CORTISOL_LEVEL (STRESS)</span>
                            <span id="stress-pct" style="color: var(--secondary)">0%</span>
                        </div>

                        <div class="progress-track">
                            <div id="stress-bar" class="progress-fill-psy"></div>
                        </div>

                        <div class="psy-status-text" id="psy-status-text">
                            NEURO-STABLE
                        </div>

                        <div class="psy-controls">
                            <button onclick="adjustStress(-10)" class="btn-psy">[- CALM]</button>
                            <button onclick="adjustStress(10)" class="btn-psy">[+ STRESS]</button>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">DOTATION</span>
                        <span style="color:var(--secondary); font-size:0.7rem;">GEAR_ASSIGNED</span>
                    </div>
                    <div id="my-equipment-list" style="max-height: 200px; overflow-y: auto; padding-right: 5px;">
                        <div class="blink" style="color: #555;">CHARGEMENT INVENTAIRE...</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title" style="color: var(--warning)">MISSIONS ASSIGN√âES</span>
                        <span style="color:var(--warning); font-size:0.7rem;">ORDERS</span>
                    </div>
                    <div id="my-missions-list" style="max-height: 200px; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 8px;">
                        <div class="blink" style="color: #555;">R√âCUP√âRATION DES ORDRES...</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">SYST√àME</span>
                        <span style="color:var(--secondary); font-size:0.7rem;">ACCESS_LOG</span>
                    </div>

                    <div class="log-entry">
                         <span style="color: var(--primary)">[+]
                             <span>CONNEXION S√âCURIS√âE √âTABLIE</span>
                         </span>
                    </div>

                    <div class="log-entry">
                         <span style="color: var(--primary)">[+]
                             <span>AUTHENTIFICATION BIOM√âTRIQUE : OK</span>
                         </span>
                    </div>

                    <div style="margin-top: 15px; border-top: 1px dashed #444; padding-top: 10px;">
                        <button onclick="logout()" class="btn-logout">[ TERMINATE SESSION ]</button>
                    </div>
                </div>

            </section>

            <footer class="footer">
                <div>SECURE TERMINAL V.4.0.2</div>
                <div>
                    <a href="database.html" style="color: var(--secondary); text-decoration: none;">[ ACC√âDER √Ä LA BASE DE DONN√âES ]</a>
                </div>
            </footer>

        </main>
    </div>

    <script src="js/profile-equipment.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sessionData = JSON.parse(localStorage.getItem('sas_session'));

            if (sessionData) {
                const { username, rank, created_at, id } = sessionData;

                // Remplissage des infos disponibles
                document.getElementById('header-username').textContent = username.toUpperCase();
                document.getElementById('card-username').textContent = username.toUpperCase();

                const rankDisplay = `LVL-${rank}`;
                document.getElementById('card-rank-code').textContent = rankDisplay;
                document.getElementById('card-rank-badge').textContent = rank >= 5 ? 'COMMAND' : (rank >= 3 ? 'OFFICER' : 'OPERATOR');

                document.getElementById('session-id').textContent = '0x' + Math.floor(Math.random()*16777215).toString(16).toUpperCase();

                // Charger les missions de l'agent
                loadMyMissions(username);
            }

            // Animation de la carte (idem)
            const card = document.getElementById('card');
            const cardContainer = document.querySelector('.id-card-container');

            cardContainer.addEventListener('mousemove', (e) => {
                const rect = cardContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = ((y - centerY) / centerY) * -10;
                const rotateY = ((x - centerX) / centerX) * 10;
                card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
            });
            cardContainer.addEventListener('mouseleave', () => {
                card.style.transform = `rotateX(0deg) rotateY(0deg) scale(1)`;
            });

            // Initialiser les effets bio
            initPsychometrics();
            initECG();
        });

        // --- FONCTION POUR CHARGER LES MISSIONS DE L'AGENT ---
        async function loadMyMissions(username) {
            const container = document.getElementById('my-missions-list');
            try {
                const res = await fetch(`/api/missions?agent=${username}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('sas_token')}` }
                });
                const missions = await res.json();

                if(missions.length === 0) {
                    container.innerHTML = '<div style="color:rgba(255,255,255,0.4); font-style:italic; font-size:0.8rem; padding:10px;">> AUCUN ORDRE EN ATTENTE</div>';
                    return;
                }

                container.innerHTML = missions.map(m => {
                    let borderCol = 'var(--warning)'; // PENDING
                    let statusText = 'PLANIFI√âE';

                    if(m.status === 'ACTIVE') {
                        borderCol = 'var(--danger)';
                        statusText = 'EN COURS';
                    }
                    if(m.status === 'COMPLETED') {
                        borderCol = 'var(--primary)';
                        statusText = 'TERMIN√âE';
                    }

                    const date = new Date(m.start_time).toLocaleDateString('fr-FR');

                    return `
                        <div style="
                            background: rgba(255,255,255,0.03);
                            border-left: 3px solid ${borderCol};
                            padding: 10px;
                            transition: background 0.2s;
                        ">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="font-weight:bold; color:#fff; font-family:'Share Tech Mono';">${m.title}</span>
                                <span style="font-size:0.65rem; color:${borderCol}; border:1px solid ${borderCol}; padding:1px 4px; border-radius:3px;">${statusText}</span>
                            </div>
                            <div style="font-size:0.75rem; color:#888; font-family:'JetBrains Mono'; display:flex; justify-content:space-between;">
                                <span>üìç ${m.location}</span>
                                <span>üìÖ ${date}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch(e) {
                console.error(e);
                container.innerHTML = '<div style="color:var(--danger)">ERREUR CONNEXION SERVEUR</div>';
            }
        }

        /* --- SYST√àME BIOM√âTRIQUE (Reste inchang√©) --- */
        function initPsychometrics() {
            let currentStress = parseInt(localStorage.getItem('sas_stress_level')) || 0;
            updateStressUI(currentStress);
        }

        function adjustStress(amount) {
            let currentStress = parseInt(localStorage.getItem('sas_stress_level')) || 0;
            currentStress += amount;
            if (currentStress < 0) currentStress = 0;
            if (currentStress > 100) currentStress = 100;
            localStorage.setItem('sas_stress_level', currentStress);
            updateStressUI(currentStress);
        }

        function updateStressUI(level) {
            const bar = document.getElementById('stress-bar');
            const pct = document.getElementById('stress-pct');
            const txt = document.getElementById('psy-status-text');
            const bpmDisplay = document.getElementById('bpm-value');

            bar.style.width = level + '%';
            pct.textContent = level + '%';

            if (level < 30) {
                bar.style.backgroundColor = '#00ff9d';
                bar.style.boxShadow = '0 0 10px #00ff9d';
                txt.textContent = "NEURO-STABLE";
                txt.style.color = '#00ff9d';
                targetBPM = 60 + (level / 2);
            } else if (level < 70) {
                bar.style.backgroundColor = '#eebb00';
                bar.style.boxShadow = '0 0 10px #eebb00';
                txt.textContent = "STRESS √âLEV√â - VIGILANCE";
                txt.style.color = '#eebb00';
                targetBPM = 90 + ((level - 30));
            } else {
                bar.style.backgroundColor = '#ff3333';
                bar.style.boxShadow = '0 0 15px #ff3333';
                txt.textContent = "CRITIQUE // TRAUMA IMMINENT";
                txt.style.color = '#ff3333';
                txt.classList.add('blink');
                targetBPM = 130 + ((level - 70) * 1.5);
            }
        }

        let ctx, canvas;
        let xPos = 0;
        let targetBPM = 65;
        let lastFrameTime = 0;

        function initECG() {
            canvas = document.getElementById('ecg-canvas');
            if(!canvas) return;

            ctx = canvas.getContext('2d');
            const wrapper = canvas.parentElement;
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;

            requestAnimationFrame(drawECG);

            setInterval(() => {
                const noise = Math.floor(Math.random() * 6) - 3;
                const finalBPM = Math.floor(targetBPM + noise);
                const el = document.getElementById('bpm-value');
                if(el) el.textContent = finalBPM;
            }, 2000);
        }

        function drawECG(timestamp) {
            if (!lastFrameTime) lastFrameTime = timestamp;
            const delta = timestamp - lastFrameTime;
            const speed = (canvas.width * (targetBPM / 60)) / 100;

            let color = '#00ff9d';
            if(targetBPM > 100) color = '#eebb00';
            if(targetBPM > 140) color = '#ff3333';

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.shadowBlur = 5;
            ctx.shadowColor = color;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            ctx.moveTo(xPos, canvas.height / 2);

            xPos += speed;

            let y = canvas.height / 2;
            const cycle = 100;
            const phase = xPos % cycle;

            if (phase > 10 && phase < 15) y -= 5;
            else if (phase > 20 && phase < 25) y += 5;
            else if (phase > 25 && phase < 35) y -= 25;
            else if (phase > 35 && phase < 40) y += 10;
            else if (phase > 50 && phase < 60) y -= 8;

            y += (Math.random() * 2 - 1);

            ctx.lineTo(xPos, y);
            ctx.stroke();

            if (xPos >= canvas.width) {
                xPos = 0;
                ctx.clearRect(0,0, canvas.width, canvas.height);
                ctx.beginPath();
            }

            lastFrameTime = timestamp;
            requestAnimationFrame(drawECG);
        }

        function logout() {
            document.body.style.transition = "opacity 0.5s";
            document.body.style.opacity = "0";
            
            setTimeout(() => {
                localStorage.removeItem('sas_session');
                localStorage.removeItem('userSecurityLevel');
                localStorage.removeItem('sas_token');
                window.location.href = 'index.html';
            }, 500);
        }
    </script>
</body>
</html>